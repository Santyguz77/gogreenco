<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="theme-color" content="#2d6943">
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Expires" content="0">
	<link rel="manifest" href="/manifest.json">
	<link rel="icon" type="image/png" href="/image.png">
	<link rel="apple-touch-icon" href="/image.png">
	<link rel="stylesheet" href="styles.css?v=2">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
	<title>Admin - Go Green</title>
	<style>
		/* Men√∫ Hamburguesa */
		.hamburger {
			display: none;
			position: fixed;
			top: 15px;
			left: 15px;
			z-index: 1001;
			background: #2d6943;
			border: none;
			color: #ffffff;
			width: 50px;
			height: 50px;
			border-radius: 50%;
			font-size: 24px;
			cursor: pointer;
			box-shadow: 0 4px 12px rgba(45, 105, 67, 0.4);
			transition: transform 0.3s;
		}
		.hamburger:active {
			transform: scale(0.95);
		}
		.mobile-overlay {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(45, 105, 67, 0.7);
			z-index: 999;
		}
		.mobile-overlay.active {
			display: block;
		}
		.sidebar.mobile-open {
			transform: translateX(0) !important;
		}
		
		@media (max-width: 768px) {
			.hamburger {
				display: flex;
				align-items: center;
				justify-content: center;
			}
			.sidebar {
				position: fixed;
				left: 0;
				top: 0;
				height: 100vh;
				transform: translateX(-100%);
				transition: transform 0.3s ease;
				z-index: 1000;
				width: 260px;
			}
			.main {
				margin-left: 0;
				padding: 80px 15px 20px 15px;
			}
		}
		
		.dashboard-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
			gap: 20px;
			margin-bottom: 30px;
			overflow: hidden;
		}
		.stat-card {
			background: linear-gradient(135deg, var(--panel), var(--card));
			padding: 25px;
			border-radius: 12px;
			box-shadow: 0 4px 12px rgba(45, 105, 67, 0.1);
			border: 1px solid rgba(45, 105, 67, 0.1);
			min-width: 0;
			overflow: hidden;
		}
		.stat-card h3 {
			font-size: 14px;
			color: var(--muted);
			text-transform: uppercase;
			margin-bottom: 10px;
		}
		.stat-card .value {
			font-size: 28px;
			font-weight: 700;
			color: var(--accent);
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			max-width: 100%;
		}
		.section {
			display: none;
		}
		.section.active {
			display: block;
		}
		.order-card {
			background: rgba(0, 0, 0, 0.3);
			padding: 15px;
			border-radius: 8px;
			margin-bottom: 15px;
			border-left: 4px solid var(--accent);
		}
		.order-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 10px;
		}
		.order-items-list {
			margin: 10px 0;
			padding: 10px;
			background: rgba(0, 0, 0, 0.2);
			border-radius: 6px;
		}
		.order-item-line {
			display: flex;
			justify-content: space-between;
			padding: 5px 0;
			border-bottom: 1px solid rgba(255, 255, 255, 0.05);
		}
		.close-cash-summary {
			background: linear-gradient(135deg, var(--success), #388e3c);
			color: #fff;
			padding: 30px;
			border-radius: 12px;
			margin-top: 20px;
		}
		.close-cash-summary h2 {
			margin-bottom: 20px;
		}
		.close-cash-line {
			display: flex;
			justify-content: space-between;
			padding: 10px 0;
			border-bottom: 1px solid rgba(255, 255, 255, 0.2);
			font-size: 18px;
		}
		.close-cash-total {
			font-size: 32px;
			font-weight: 700;
			margin-top: 20px;
			text-align: right;
		}
		
		@keyframes pulse {
			0%, 100% { opacity: 1; transform: scale(1); }
			50% { opacity: 0.5; transform: scale(1.2); }
		}
		
		@keyframes slideIn {
			from { transform: translateX(400px); opacity: 0; }
			to { transform: translateX(0); opacity: 1; }
		}
		
		@keyframes slideOut {
			from { transform: translateX(0); opacity: 1; }
			to { transform: translateX(400px); opacity: 0; }
		}
	</style>
</head>
<body>
	<script>
		// Verificar sesi√≥n de admin
		const session = localStorage.getItem('userSession');
		if (!session) {
			window.location.href = '/login.html';
		} else {
			const userData = JSON.parse(session);
			if (userData.type !== 'admin') {
				alert('‚ö†Ô∏è Acceso denegado. Esta p√°gina es solo para administradores.');
				window.location.href = '/login.html';
			}
		}
	</script>
	<!-- Bot√≥n Hamburguesa (solo m√≥vil) -->
	<button class="hamburger" onclick="toggleMobileMenu()" aria-label="Men√∫">
		‚ò∞
	</button>
	
	<!-- Overlay para cerrar men√∫ en m√≥vil -->
	<div class="mobile-overlay" onclick="closeMobileMenu()"></div>
	
	<div class="app">
		<!-- Sidebar -->
		<div class="sidebar" id="sidebar">
			<div class="brand">
				<img src="image.png" alt="Logo" style="width: 60px; height: 60px; border-radius: 50%; margin-bottom: 10px;">
				<div>Go Green</div>
				<span>Moda Circular</span>
			</div>
			<ul class="menu">
				<li class="active" onclick="showSection('dashboard'); closeMobileMenu();">
					<span class="menu-icon">üìä</span> Dashboard
				</li>
				<li onclick="showSection('orders'); closeMobileMenu();">
					<span class="menu-icon">üìù</span> Pedidos
				</li>
				<li onclick="showSection('menu-config'); closeMobileMenu();">
					<span class="menu-icon">üëó</span> Cat√°logo
				</li>
				<li onclick="showSection('transactions'); closeMobileMenu();">
					<span class="menu-icon">üí∞</span> Finanzas
				</li>
				<li onclick="showSection('close-cash'); closeMobileMenu();">
					<span class="menu-icon">üîí</span> Cierre de Caja
				</li>
				<li onclick="showSection('system-config'); closeMobileMenu();">
					<span class="menu-icon">‚öôÔ∏è</span> Configuraci√≥n
				</li>
				<li onclick="logout()" style="margin-top: 20px; border-top: 1px solid rgba(255,107,53,0.2); padding-top: 15px;">
					<span class="menu-icon">üö™</span> Cerrar Sesi√≥n
				</li>
			</ul>
		</div>

		<!-- Main Content -->
		<div class="main">
			<!-- Dashboard -->
			<div id="dashboard" class="section active">
				<div class="header">
					<h1>Dashboard</h1>
					<div style="display: flex; align-items: center; gap: 15px;">
						<button class="btn" onclick="refreshData()">üîÑ Actualizar</button>
						<span style="color: #4caf50; font-size: 14px; display: flex; align-items: center; gap: 5px;">
							<span style="width: 8px; height: 8px; background: #4caf50; border-radius: 50%; animation: pulse 2s infinite;"></span>
							Auto-actualizaci√≥n activa
						</span>
					</div>
				</div>

				<div class="dashboard-grid">
					<div class="stat-card">
						<h3>üí∞ Ventas Hoy</h3>
						<div class="value" id="stat-sales">$0</div>
						<small style="color: var(--muted); font-size: 13px;" id="stat-sales-count">0 pedidos</small>
					</div>
					<div class="stat-card">
						<h3>üìÖ Total Mes</h3>
						<div class="value" id="stat-month">$0</div>
						<small style="color: var(--muted); font-size: 13px;" id="stat-month-count">0 pedidos</small>
					</div>
					<div class="stat-card">
						<h3>üìä Ticket Promedio</h3>
						<div class="value" id="stat-avg-ticket">$0</div>
						<small style="color: var(--muted); font-size: 13px;">Por pedido</small>
					</div>
					<div class="stat-card">
						<h3>üì¶ Pedidos Activos</h3>
						<div class="value" id="stat-orders">0</div>
						<small style="color: var(--muted); font-size: 13px;" id="stat-products">0 productos</small>
					</div>
				</div>

				<!-- M√©tricas Adicionales -->
				<div class="dashboard-grid" style="margin-top: 20px;">
					<div class="stat-card">
						<h3>üìÜ Total A√±o</h3>
						<div class="value" id="stat-year">$0</div>
						<small style="color: var(--muted); font-size: 13px;" id="stat-year-count">0 pedidos</small>
					</div>
					<div class="stat-card">
						<h3>üìà Crecimiento</h3>
						<div class="value" id="stat-growth">0%</div>
						<small style="color: var(--muted); font-size: 13px;">vs mes anterior</small>
					</div>
					<div class="stat-card">
						<h3>üî• Mejor D√≠a</h3>
						<div class="value" id="stat-best-day" style="font-size: 18px;">-</div>
						<small style="color: var(--muted); font-size: 13px;" id="stat-best-day-amount">$0</small>
					</div>
					<div class="stat-card">
						<h3>‚è∞ Hora Pico</h3>
						<div class="value" id="stat-peak-hour">-</div>
						<small style="color: var(--muted); font-size: 13px;" id="stat-peak-hour-orders">0 pedidos</small>
					</div>
				</div>

				<!-- Pedidos en Tiempo Real -->
				<div class="card" style="margin-top: 20px;">
					<h3>üì¶ Pedidos en Tiempo Real</h3>
					<div id="dashboard-orders-realtime"></div>
				</div>

				<!-- Gr√°ficas -->
			<div class="charts-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px; margin-top: 20px; overflow: hidden;">
				<div class="card">
					<h3 style="margin-bottom: 20px;">üìà Ventas √öltimos 7 D√≠as</h3>
					<canvas id="sales-chart" style="max-height: 250px; max-width: 100%;"></canvas>
				</div>

				<div class="card">
					<h3 style="margin-bottom: 20px;">üèÜ Productos M√°s Vendidos</h3>
					<canvas id="products-chart" style="max-height: 250px; max-width: 100%;"></canvas>
				</div>

				<div class="card">
					<h3 style="margin-bottom: 20px;">üìä Evoluci√≥n Mensual</h3>
					<canvas id="monthly-chart" style="max-height: 250px; max-width: 100%;"></canvas>
				</div>

				<div class="card">
					<h3 style="margin-bottom: 20px;">üè∑Ô∏è Categor√≠as M√°s Vendidas</h3>
					<canvas id="category-chart" style="max-height: 250px; max-width: 100%;"></canvas>
				</div>
			</div>
		</div>

		<!-- Pedidos -->
		<div id="orders" class="section">
			<div class="header">
				<h1>Pedidos Activos</h1>
					<div class="controls">
						<button class="btn btn-success" onclick="refreshData()">üîÑ Actualizar</button>
					</div>
				</div>
				<div class="card" id="orders-list"></div>
			</div>

			<!-- Cat√°logo de Productos -->
			<div id="menu-config" class="section">
				<div class="header">
					<h1>Cat√°logo de Productos</h1>
					<button class="btn" onclick="openMenuItemModal()">‚ûï Nuevo Producto</button>
				</div>
				<div class="card">
					<div class="table-scroll">
						<table id="menu-table">
							<thead>
								<tr>
									<th>Nombre</th>
									<th>Descripci√≥n</th>
									<th>Categor√≠a</th>
									<th>Costo</th>
									<th>Precio</th>
									<th>Ganancia</th>
									<th>Margen</th>
									<th>Visible en Cat√°logo</th>
									<th>Acciones</th>
								</tr>
							</thead>
							<tbody></tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- Finanzas -->
			<div id="transactions" class="section">
				<div class="header">
					<h1>Historial de Transacciones</h1>
				</div>
				<div class="card">
					<div class="table-scroll">
						<table id="transactions-table">
							<thead>
								<tr>
									<th>Fecha</th>
									<th>Cliente</th>
									<th>Concepto</th>
									<th>Monto</th>
									<th>Acciones</th>
								</tr>
							</thead>
							<tbody></tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- Cierre de Caja -->
			<div id="close-cash" class="section">
				<div class="header">
					<h1>Cierre de Caja</h1>
					<div class="controls">
						<button class="btn btn-warning" onclick="generateCloseCash()">üìÑ Generar Cierre Actual</button>
						<button class="btn btn-secondary" onclick="viewClosureHistory()">üìã Historial</button>
					</div>
				</div>
				<div class="card">
					<div id="close-cash-content">
						<p class="text-center" style="color: var(--muted); padding: 40px;">
							Haz clic en "Generar Cierre Actual" para ver el resumen del d√≠a
						</p>
					</div>
				</div>

				<div id="closure-history" style="margin-top: 20px; display: none;">
					<h3 style="color: var(--accent); margin-bottom: 15px;">Historial de Cierres</h3>
					<div class="table-scroll">
						<table id="closures-table">
							<thead>
								<tr>
									<th>Fecha</th>
									<th>Transacciones</th>
									<th>Total</th>
									<th>Acciones</th>
								</tr>
							</thead>
							<tbody></tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- Configuraci√≥n del Sistema -->
			<div id="system-config" class="section">
				<div class="header">
					<h1>Configuraci√≥n del Sistema</h1>
				</div>

				<div class="card" style="margin-bottom: 20px;">
					<h3 style="color: var(--accent); margin-bottom: 15px;">üîî Notificaciones</h3>
					<p style="color: var(--muted); margin-bottom: 20px;">
						Configura las alertas de nuevos pedidos en tu dispositivo m√≥vil o computadora.
					</p>
					
					<div style="background: var(--panel); border: 2px solid var(--accent); padding: 20px; border-radius: 8px; margin-bottom: 15px;">
						<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
							<span style="font-size: 40px;">üì±</span>
							<div style="flex: 1;">
								<h4 style="color: var(--accent); margin-bottom: 5px;">Notificaciones Push del Sistema</h4>
								<p style="color: var(--muted); font-size: 14px; margin: 0;">
									Recibe alertas como las de WhatsApp o YouTube directamente en tu dispositivo, incluso cuando la app est√© en segundo plano.
								</p>
							</div>
						</div>
						
						<div id="notification-status" style="padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 14px;"></div>
						
						<button class="btn" onclick="enableNotifications()" id="enable-notifications-btn" style="width: 100%;">
							üîî Activar Notificaciones
						</button>
					</div>
				</div>

				<div class="card" style="margin-bottom: 20px;">
					<h3 style="color: #ff4444; margin-bottom: 15px;">‚ö†Ô∏è Zona de Peligro</h3>
					<p style="color: var(--muted); margin-bottom: 20px;">
						Estas acciones son <strong>irreversibles</strong>. √ösalas con precauci√≥n.
					</p>
					
					<div style="background: rgba(255, 68, 68, 0.1); border: 2px solid #ff4444; padding: 20px; border-radius: 8px;">
						<h4 style="color: #ff4444; margin-bottom: 10px;">üóëÔ∏è Limpiar Datos de Ventas</h4>
						<p style="color: var(--muted); margin-bottom: 15px; font-size: 14px;">
							Elimina todas las √≥rdenes, transacciones y cierres de caja. <strong>NO elimina</strong> productos del cat√°logo.
							√ötil para entregar la aplicaci√≥n como nueva o resetear datos de prueba.
						</p>
						<ul style="color: var(--muted); margin: 15px 0; padding-left: 25px; font-size: 14px;">
							<li>‚úì Se eliminar√°n todos los pedidos (completados, pendientes, cancelados)</li>
							<li>‚úì Se eliminar√°n todas las transacciones</li>
							<li>‚úì Se eliminar√°n todos los cierres de caja</li>
							<li>‚úó Los productos del cat√°logo se mantendr√°n</li>
							<li>‚úó Las facturas guardadas se eliminar√°n</li>
						</ul>
						<button class="btn" style="background: #ff4444; border: none;" onclick="resetSalesData()">
							üóëÔ∏è Limpiar Todos los Datos de Ventas
						</button>
					</div>
				</div>

				<div class="card">
					<h3 style="margin-bottom: 15px;">‚ÑπÔ∏è Informaci√≥n del Sistema</h3>
					<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
						<div style="background: var(--panel); padding: 15px; border-radius: 8px;">
							<div style="color: var(--muted); font-size: 13px;">Productos en Cat√°logo</div>
							<div style="color: var(--accent); font-size: 24px; font-weight: 700;" id="info-menu-items">0</div>
						</div>
						<div style="background: var(--panel); padding: 15px; border-radius: 8px;">
							<div style="color: var(--muted); font-size: 13px;">Pedidos Totales</div>
							<div style="color: var(--accent); font-size: 24px; font-weight: 700;" id="info-orders">0</div>
						</div>
						<div style="background: var(--panel); padding: 15px; border-radius: 8px;">
							<div style="color: var(--muted); font-size: 13px;">Clientes Atendidos</div>
							<div style="color: var(--accent); font-size: 24px; font-weight: 700;" id="info-customers">0</div>
						</div>
						<div style="background: var(--panel); padding: 15px; border-radius: 8px;">
							<div style="color: var(--muted); font-size: 13px;">Facturas Guardadas</div>
							<div style="color: var(--accent); font-size: 24px; font-weight: 700;" id="info-invoices">0</div>
						</div>
					</div>
				</div>
			</div>
		</div> <!-- fin main -->
	</div> <!-- fin app -->

	<!-- Modal Producto Men√∫ -->
	<div id="menu-item-modal" class="modal">
		<div class="panel">
			<div class="modal-header">
				<h3 id="menu-item-modal-title">Nuevo Producto</h3>
				<button class="modal-close" onclick="closeMenuItemModal()">‚úï</button>
			</div>
			<div class="form-group">
				<label>Nombre</label>
				<input type="text" id="item-name" placeholder="Ej: Hamburguesa Cl√°sica">
			</div>
			<div class="form-group">
				<label>Descripci√≥n</label>
				<textarea id="item-description" placeholder="Descripci√≥n del producto"></textarea>
			</div>
			<div class="form-group">
				<label>Categor√≠a</label>
				<input type="text" id="item-category" placeholder="Ej: Hamburguesas">
			</div>
			<div class="form-row">
				<div class="form-group" style="flex: 1;">
					<label>Costo de Producci√≥n</label>
					<input type="number" id="item-cost" placeholder="0.00" step="0.01" oninput="updateProfitPreview()">
					<small style="color: var(--muted); display: block; margin-top: 4px;">¬øCu√°nto te cuesta producirlo?</small>
				</div>
				<div class="form-group" style="flex: 1;">
					<label>Precio de Venta</label>
					<input type="number" id="item-price" placeholder="0.00" step="0.01" oninput="updateProfitPreview()">
					<small style="color: var(--muted); display: block; margin-top: 4px;">¬øA cu√°nto lo vendes?</small>
				</div>
			</div>
			<div id="profit-preview" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px; display: none;">
				<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
					<span>Ganancia por unidad:</span>
					<strong id="profit-amount" style="color: var(--accent);">$0.00</strong>
				</div>
				<div style="display: flex; justify-content: space-between;">
					<span>Margen de ganancia:</span>
					<strong id="profit-margin" style="color: var(--accent);">0%</strong>
				</div>
			</div>
			<div class="form-group">
				<label>Imagen del Producto</label>
				<input type="file" id="item-image-file" accept="image/*" onchange="handleImageUpload(this)" style="width: 100%;">
				<small style="color: var(--muted); display: block; margin-top: 4px;">Sube una imagen desde tu dispositivo</small>
				<div id="item-image-preview" style="margin-top: 10px;"></div>
				<input type="hidden" id="item-image">
			</div>
			<div class="form-group">
				<label>
					<input type="checkbox" id="item-available" checked> Disponible
				</label>
			</div>
			<div class="controls">
				<button class="btn" onclick="saveMenuItem()">üíæ Guardar</button>
				<button class="btn btn-secondary" onclick="closeMenuItemModal()">Cancelar</button>
			</div>
		</div>
	</div>

	<!-- Modal Detalle de Mesa -->
	<div id="table-detail-modal" class="modal">
		<div class="panel">
			<div class="modal-header">
				<h3 id="table-detail-title">Detalle Mesa</h3>
				<button class="modal-close" onclick="closeTableDetailModal()">‚úï</button>
			</div>
			<div id="table-detail-content"></div>
		</div>
	</div>

	<!-- Modal Tomar Pedido -->
	<div id="order-modal" class="modal">
		<div class="panel" style="max-width: 1200px;">
			<div class="modal-header">
				<h3 id="order-modal-title">Nuevo Pedido</h3>
				<button class="modal-close" onclick="closeOrderModal()">‚úï</button>
			</div>
			
			<div style="display: grid; grid-template-columns: 1fr 400px; gap: 20px;">
				<!-- Men√∫ de productos -->
				<div style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
					<h4 style="color: var(--accent); margin-bottom: 15px;">üçî Seleccionar Productos</h4>
					<div id="order-menu-items"></div>
				</div>
				
				<!-- Resumen del pedido -->
				<div style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.1);">
					<h4 style="color: var(--accent); margin-bottom: 15px;">üìù Pedido Actual</h4>
					<div id="order-items-summary" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;"></div>
					
					<div style="background: linear-gradient(135deg, #ffffff, #e0e0e0); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
						<div style="font-size: 14px; color: #000000; margin-bottom: 5px; font-weight: 600;">Total a Pagar</div>
						<div id="order-total-amount" style="font-size: 32px; font-weight: 700; color: #000000;">$0.00</div>
					</div>
					
					<div style="display: flex; flex-direction: column; gap: 10px;">
						<button class="btn" onclick="saveOrderFromModal()" style="width: 100%;">üíæ Guardar Pedido</button>
						<button class="btn btn-secondary" onclick="closeOrderModal()" style="width: 100%;">Cancelar</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="app.js"></script>
	<script>
		let currentEditingTable = null;
		let currentEditingMenuItem = null;
		let autoRefreshInterval = null;
		let isRefreshing = false;
		let lastKnownOrderIds = new Set();
		let notificationSound = null;

		async function init() {
			await loadInitialData();
			await initializeDefaultData();
			// Inicializar IDs de pedidos conocidos
			AppState.orders.forEach(order => lastKnownOrderIds.add(order.id));
			renderDashboard();
			renderAllSections();
			startAutoRefresh();
			// Actualizar estado de notificaciones
			updateNotificationStatus();
		}
		
		// Auto-actualizaci√≥n cada 5 segundos
		function startAutoRefresh() {
			// Limpiar intervalo anterior si existe
			if (autoRefreshInterval) {
				clearInterval(autoRefreshInterval);
			}
			
			// Actualizar cada 5 segundos
			autoRefreshInterval = setInterval(async () => {
				if (!isRefreshing) {
					isRefreshing = true;
					try {
						const oldOrdersCount = AppState.orders.length;
						await loadInitialData();
						
						// Detectar nuevos pedidos
						checkForNewOrders();
						
						// Solo actualizar la secci√≥n activa para no interrumpir formularios
						const activeSection = document.querySelector('.section.active');
						if (activeSection) {
							const sectionId = activeSection.id;
							if (sectionId === 'dashboard') renderDashboard();
							if (sectionId === 'orders') renderOrders();
							if (sectionId === 'transactions') renderTransactions();
						}
						
						// Actualizar badge de notificaciones si hay pedidos nuevos
						updateNotificationBadge();
					} catch (error) {
						console.error('Error en auto-refresh:', error);
					} finally {
						isRefreshing = false;
					}
				}
			}, 5000); // 5 segundos
		}
		
		function stopAutoRefresh() {
			if (autoRefreshInterval) {
				clearInterval(autoRefreshInterval);
				autoRefreshInterval = null;
			}
		}
		
		function updateNotificationBadge() {
			const activeOrders = AppState.orders.filter(o => o.status === 'pending').length;
			if (activeOrders > 0) {
				document.title = `(${activeOrders}) Admin - Go Green`;
			} else {
				document.title = 'Admin - Go Green';
			}
		}

		// SISTEMA DE NOTIFICACIONES PARA NUEVOS PEDIDOS
		function checkForNewOrders() {
			const currentOrderIds = new Set(AppState.orders.map(o => o.id));
			
			// Encontrar pedidos nuevos
			AppState.orders.forEach(order => {
				if (!lastKnownOrderIds.has(order.id)) {
					// Es un pedido nuevo
					showNewOrderNotification(order);
					lastKnownOrderIds.add(order.id);
				}
			});
			
			// Limpiar IDs de pedidos que ya no existen
			if (lastKnownOrderIds.size > 100) {
				lastKnownOrderIds = new Set(AppState.orders.map(o => o.id));
			}
		}

		function showNewOrderNotification(order) {
			// Reproducir sonido
			playNotificationSound();
			
			// Determinar el nombre del cliente o identificador
			const hasCustomer = order.customerData && order.customerData.name;
			const orderLabel = hasCustomer 
				? order.customerData.name 
				: 'Cat√°logo Virtual';
			
			// Mostrar notificaci√≥n visual
			const notifDiv = document.createElement('div');
			notifDiv.style.cssText = `
				position: fixed;
				top: 80px;
				right: 30px;
				background: linear-gradient(135deg, #2d6943 0%, #1f4a2f 100%);
				color: #fff;
				padding: 20px 30px;
				border-radius: 12px;
				box-shadow: 0 8px 30px rgba(45, 105, 67, 0.5);
				z-index: 10000;
				font-size: 16px;
				font-weight: 600;
				animation: slideInRight 0.5s ease;
				min-width: 320px;
				max-width: 400px;
				cursor: pointer;
			`;
			
			notifDiv.innerHTML = `
				<div style="display: flex; align-items: center; gap: 15px;">
					<span style="font-size: 40px;">üõçÔ∏è</span>
					<div>
						<div style="font-size: 18px; margin-bottom: 5px;">¬°Nuevo Pedido!</div>
						<div style="font-size: 14px; opacity: 0.9;">Cliente: ${orderLabel}</div>
						<div style="font-size: 13px; opacity: 0.8; margin-top: 3px;">Total: ${Utils.formatCurrency(order.total)}</div>
					</div>
				</div>
			`;

			// Click para ir a pedidos
			notifDiv.onclick = () => {
				showSection('orders');
				notifDiv.remove();
			};

			document.body.appendChild(notifDiv);

			// Animar y remover despu√©s de 8 segundos
			setTimeout(() => {
				notifDiv.style.animation = 'slideOutRight 0.5s ease';
				setTimeout(() => notifDiv.remove(), 500);
			}, 8000);
			
			// Intentar enviar notificaci√≥n del navegador
			requestBrowserNotification(order, orderLabel);
		}

		function playNotificationSound() {
			try {
				const audioContext = new (window.AudioContext || window.webkitAudioContext)();
				
				// Triple beep alegre
				const playBeep = (frequency, startTime, duration) => {
					const oscillator = audioContext.createOscillator();
					const gainNode = audioContext.createGain();
					
					oscillator.connect(gainNode);
					gainNode.connect(audioContext.destination);
					
					oscillator.frequency.value = frequency;
					oscillator.type = 'sine';
					gainNode.gain.value = 0.3;
					
					oscillator.start(startTime);
					oscillator.stop(startTime + duration);
				};

				const now = audioContext.currentTime;
				playBeep(800, now, 0.15);
				playBeep(1000, now + 0.2, 0.15);
				playBeep(1200, now + 0.4, 0.25);
			} catch (error) {
				console.log('No se pudo reproducir sonido');
			}
		}

		async function requestBrowserNotification(order, orderLabel) {
			// Verificar si el navegador soporta notificaciones
			if (!("Notification" in window)) {
				console.log('Notificaciones no soportadas en este navegador');
				return;
			}

			// Solicitar permiso si no se ha hecho
			if (Notification.permission === "default") {
				const permission = await Notification.requestPermission();
				if (permission === "denied") {
					console.log('Permiso de notificaciones denegado');
					return;
				}
			}

			// Mostrar notificaci√≥n si tenemos permiso
			if (Notification.permission === "granted") {
				// Vibraci√≥n en dispositivos m√≥viles
				if ('vibrate' in navigator) {
					navigator.vibrate([200, 100, 200]); // Patr√≥n de vibraci√≥n
				}

				// Construir cuerpo del mensaje con productos
				const itemsText = order.items.slice(0, 2).map(item => 
					`‚Ä¢ ${item.quantity}x ${item.name}`
				).join('\n');
				const moreItems = order.items.length > 2 ? `\n+${order.items.length - 2} productos m√°s` : '';
				
				const notificationOptions = {
					body: `Cliente: ${orderLabel}\n${itemsText}${moreItems}\n\nTotal: ${Utils.formatCurrency(order.total)}`,
					icon: "/image.png",
					badge: "/icon-192.png",
					tag: `order-${order.id}`,
					requireInteraction: true, // En m√≥vil, mantiene la notificaci√≥n hasta que el usuario interact√∫e
					silent: false,
					vibrate: [200, 100, 200],
					timestamp: Date.now(),
					data: { orderId: order.id, section: 'orders' }
				};

				// Usar Service Worker para mostrar notificaciones en m√≥viles
				if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
					// Enviar mensaje al Service Worker para mostrar la notificaci√≥n
					navigator.serviceWorker.controller.postMessage({
						type: 'SHOW_NOTIFICATION',
						title: 'üîî Nuevo Pedido - Go Green',
						options: notificationOptions
					});
				} else {
					// Fallback: notificaci√≥n directa (para desktop o si SW no est√° disponible)
					const notification = new Notification("üîî Nuevo Pedido - Go Green", notificationOptions);

					notification.onclick = () => {
						window.focus();
						showSection('orders');
						notification.close();
					};

					// En desktop, auto cerrar despu√©s de 15 segundos
					if (!('ontouchstart' in window)) {
						setTimeout(() => notification.close(), 15000);
					}
				}
			}
		}

		// Escuchar mensajes del Service Worker
		if ('serviceWorker' in navigator) {
			navigator.serviceWorker.addEventListener('message', event => {
				if (event.data && event.data.type === 'NAVIGATE_TO_ORDERS') {
					showSection('orders');
				}
			});
		}

		// Solicitar permiso de notificaciones al cargar
		if ("Notification" in window && Notification.permission === "default") {
			setTimeout(async () => {
				// Mostrar un mensaje amigable antes de solicitar permiso
				const shouldAsk = confirm("üîî ¬øDeseas recibir notificaciones de nuevos pedidos en tu dispositivo?\n\nEsto te permitir√° estar al tanto incluso cuando la app est√© en segundo plano.");
				if (shouldAsk) {
					const permission = await Notification.requestPermission();
					if (permission === "granted") {
						// Mostrar notificaci√≥n de prueba usando Service Worker
						const testOptions = {
							body: "Recibir√°s alertas de nuevos pedidos en tiempo real",
							icon: "/image.png",
							badge: "/icon-192.png",
							requireInteraction: false,
							vibrate: [200, 100, 200]
						};

						if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
							navigator.serviceWorker.controller.postMessage({
								type: 'SHOW_NOTIFICATION',
								title: '‚úÖ Notificaciones Activadas',
								options: testOptions
							});
						} else {
							const testNotif = new Notification("‚úÖ Notificaciones Activadas", testOptions);
							setTimeout(() => testNotif.close(), 3000);
						}
					}
				}
			}, 5000); // Esperar 5 segundos despu√©s de cargar para no ser intrusivo
		}

		// SISTEMA DE NOTIFICACIONES DE COCINA
		// Para mismo dispositivo (mismo localStorage)
		window.addEventListener('storage', (e) => {
			if (e.key === 'kitchenNotification' && e.newValue) {
				const notification = JSON.parse(e.newValue);
				showKitchenReadyNotification(notification);
				// Limpiar la notificaci√≥n
				localStorage.removeItem('kitchenNotification');
			}
		});

		// Para diferentes dispositivos (polling de pedidos listos)
		let lastNotifiedOrders = new Set();
		setInterval(async () => {
			// Verificar pedidos que est√°n completamente listos y no han sido notificados
			const ordersToNotify = AppState.orders.filter(order => {
				return order.status === 'pending' && 
				       order.items.length > 0 &&
				       order.items.every(item => item.kitchenStatus === 'ready') &&
				       order.kitchenNotifiedAt && 
				       !lastNotifiedOrders.has(order.id);
			});

			for (const order of ordersToNotify) {
				// Verificar que la notificaci√≥n es reciente (√∫ltimos 10 segundos)
				const notifiedTime = new Date(order.kitchenNotifiedAt).getTime();
				const now = Date.now();
				if (now - notifiedTime < 10000) {
					lastNotifiedOrders.add(order.id);
					showKitchenReadyNotification({
						tableNumber: order.tableNumber,
						orderId: order.id,
						timestamp: order.kitchenNotifiedAt
					});
				}
			}

			// Limpiar pedidos antiguos del set
			if (lastNotifiedOrders.size > 50) {
				lastNotifiedOrders.clear();
			}
		}, 2000); // Verificar cada 2 segundos

		function showKitchenReadyNotification(notification) {
			// Reproducir sonido de notificaci√≥n
			playKitchenNotificationSound();

			// Mostrar notificaci√≥n visual
			const notifDiv = document.createElement('div');
			notifDiv.style.cssText = `
				position: fixed;
				top: 80px;
				right: 30px;
				background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
				color: #fff;
				padding: 20px 30px;
				border-radius: 12px;
				box-shadow: 0 8px 30px rgba(76, 175, 80, 0.5);
				z-index: 10000;
				font-size: 16px;
				font-weight: 600;
				animation: slideInRight 0.5s ease;
				min-width: 300px;
			`;
			
			notifDiv.innerHTML = `
				<div style="display: flex; align-items: center; gap: 15px;">
					<span style="font-size: 40px;">‚úÖ</span>
					<div>
						<div style="font-size: 18px; margin-bottom: 5px;">¬°Pedido Listo!</div>
						<div style="font-size: 14px; opacity: 0.9;">Mesa ${notification.tableNumber}</div>
					</div>
				</div>
			`;

			document.body.appendChild(notifDiv);

			// Animar y remover despu√©s de 5 segundos
			setTimeout(() => {
				notifDiv.style.animation = 'slideOutRight 0.5s ease';
				setTimeout(() => notifDiv.remove(), 500);
			}, 5000);

			// Actualizar datos para reflejar el estado
			loadInitialData().then(() => {
				renderAllSections();
			});
		}

		function playKitchenNotificationSound() {
			try {
				const audioContext = new (window.AudioContext || window.webkitAudioContext)();
				
				// Primer beep
				const playBeep = (frequency, startTime, duration) => {
					const oscillator = audioContext.createOscillator();
					const gainNode = audioContext.createGain();
					
					oscillator.connect(gainNode);
					gainNode.connect(audioContext.destination);
					
					oscillator.frequency.value = frequency;
					oscillator.type = 'sine';
					gainNode.gain.value = 0.3;
					
					oscillator.start(startTime);
					oscillator.stop(startTime + duration);
				};

				// Triple beep melodioso
				const now = audioContext.currentTime;
				playBeep(600, now, 0.15);
				playBeep(800, now + 0.2, 0.15);
				playBeep(1000, now + 0.4, 0.3);
			} catch (error) {
				console.log('No se pudo reproducir sonido');
			}
		}

		// Agregar estilos de animaci√≥n
		const style = document.createElement('style');
		style.textContent = `
			@keyframes slideInRight {
				from {
					transform: translateX(400px);
					opacity: 0;
				}
				to {
					transform: translateX(0);
					opacity: 1;
				}
			}
			@keyframes slideOutRight {
				from {
					transform: translateX(0);
					opacity: 1;
				}
				to {
					transform: translateX(400px);
					opacity: 0;
				}
			}
		`;
		document.head.appendChild(style);

		function showSection(sectionId) {
			document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
		const section = document.getElementById(sectionId);
		if (section) {
			section.classList.add('active');
		}
		
		document.querySelectorAll('.menu li').forEach(li => li.classList.remove('active'));
		const clickedLi = document.querySelector(`[onclick*="${sectionId}"]`)?.closest('li');
		if (clickedLi) {
			clickedLi.classList.add('active');
		}
			if (sectionId === 'menu-config') {
				stopAutoRefresh();
			} else {
				startAutoRefresh();
			}
			
			if (sectionId === 'dashboard') renderDashboard();
			if (sectionId === 'orders') renderOrders();
			if (sectionId === 'menu-config') renderMenuConfig();
			if (sectionId === 'transactions') renderTransactions();
			
			if (sectionId === 'system-config') updateSystemInfo();
		}

		async function refreshData() {
			const btn = event.target;
			btn.disabled = true;
			btn.textContent = '‚è≥ Actualizando...';
			
			await loadInitialData();
			renderAllSections();
			
			btn.disabled = false;
			btn.innerHTML = 'üîÑ Actualizar';
			
			// Mostrar notificaci√≥n temporal
			const notification = document.createElement('div');
			notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ffffff; color: #000000; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(255,255,255,0.3); z-index: 9999; animation: slideIn 0.3s ease;';
			notification.textContent = '‚úÖ Datos actualizados';
			document.body.appendChild(notification);
			
			setTimeout(() => {
				notification.style.animation = 'slideOut 0.3s ease';
				setTimeout(() => notification.remove(), 300);
			}, 2000);
		}

		function renderAllSections() {
			renderDashboard();
			renderOrders();
			renderMenuConfig();
			renderTransactions();
		}

		// DASHBOARD
		function renderDashboard() {
			const availableProducts = AppState.menuItems.filter(item => item.available).length;
			const activeOrders = AppState.orders.filter(o => o.status === 'pending').length;
			
			// Calcular ventas bas√°ndose en √≥rdenes completadas
			const today = Utils.getDateKey();
			const thisMonth = Utils.getMonthKey();
			
			let todaySales = 0;
			let monthSales = 0;
			let todayOrdersCount = 0;
			let monthOrdersCount = 0;
			
			AppState.orders.filter(o => o.status === 'completed').forEach(order => {
				const orderDate = Utils.getDateKeyFromISO(order.completedAt);
				const orderMonth = Utils.getMonthKeyFromISO(order.completedAt);
				
				let orderTotal = 0;
				order.items.forEach(item => {
					orderTotal += item.price * item.quantity;
				});
				
				if (orderDate === today) {
					todaySales += orderTotal;
					todayOrdersCount++;
				}
				if (orderMonth === thisMonth) {
					monthSales += orderTotal;
					monthOrdersCount++;
				}
			});

			// Calcular ticket promedio
			const avgTicket = monthOrdersCount > 0 ? monthSales / monthOrdersCount : 0;

			// Calcular ventas del a√±o
			const thisYear = new Date().getFullYear();
			let yearSales = 0;
			let yearOrdersCount = 0;
			
			AppState.orders.filter(o => o.status === 'completed').forEach(order => {
				const orderYear = new Date(order.completedAt).getFullYear();
				if (orderYear === thisYear) {
					let orderTotal = 0;
					order.items.forEach(item => {
						orderTotal += item.price * item.quantity;
					});
					yearSales += orderTotal;
					yearOrdersCount++;
				}
			});

			// Calcular crecimiento vs mes anterior
			const lastMonth = Utils.getLastMonthKey();
			let lastMonthSales = 0;
			
			AppState.orders.filter(o => o.status === 'completed').forEach(order => {
				const orderMonth = Utils.getMonthKeyFromISO(order.completedAt);
				if (orderMonth === lastMonth) {
					let orderTotal = 0;
					order.items.forEach(item => {
						orderTotal += item.price * item.quantity;
					});
					lastMonthSales += orderTotal;
				}
			});

			const growth = lastMonthSales > 0 ? ((monthSales - lastMonthSales) / lastMonthSales * 100) : 0;

			// Calcular mejor d√≠a
			const salesByDay = {};
			AppState.orders.filter(o => o.status === 'completed').forEach(order => {
				const orderDate = Utils.getDateKeyFromISO(order.completedAt);
				if (!salesByDay[orderDate]) {
					salesByDay[orderDate] = 0;
				}
				let orderTotal = 0;
				order.items.forEach(item => {
					orderTotal += item.price * item.quantity;
				});
				salesByDay[orderDate] += orderTotal;
			});

			let bestDay = '-';
			let bestDayAmount = 0;
			Object.entries(salesByDay).forEach(([date, amount]) => {
				if (amount > bestDayAmount) {
					bestDayAmount = amount;
					const [year, month, day] = date.split('-');
					bestDay = `${day}/${month}`;
				}
			});

			// Calcular hora pico
			const ordersByHour = {};
			AppState.orders.filter(o => o.status === 'completed').forEach(order => {
				const hour = new Date(order.completedAt).getHours();
				if (!ordersByHour[hour]) {
					ordersByHour[hour] = 0;
				}
				ordersByHour[hour]++;
			});

			let peakHour = '-';
			let peakHourOrders = 0;
			Object.entries(ordersByHour).forEach(([hour, count]) => {
				if (count > peakHourOrders) {
					peakHourOrders = count;
					peakHour = `${hour}:00`;
				}
			});

			// Actualizar estad√≠sticas principales
			document.getElementById('stat-sales').textContent = Utils.formatCurrency(todaySales);
			document.getElementById('stat-sales-count').textContent = `${todayOrdersCount} pedidos`;
			document.getElementById('stat-month').textContent = Utils.formatCurrency(monthSales);
			document.getElementById('stat-month-count').textContent = `${monthOrdersCount} pedidos`;
			document.getElementById('stat-avg-ticket').textContent = Utils.formatCurrency(avgTicket);
			document.getElementById('stat-orders').textContent = activeOrders;
			document.getElementById('stat-products').textContent = `${availableProducts} productos`;

			// Actualizar estad√≠sticas adicionales
			document.getElementById('stat-year').textContent = Utils.formatCurrency(yearSales);
			document.getElementById('stat-year-count').textContent = `${yearOrdersCount} pedidos`;
			document.getElementById('stat-growth').textContent = growth >= 0 ? `+${growth.toFixed(1)}%` : `${growth.toFixed(1)}%`;
			document.getElementById('stat-growth').style.color = growth >= 0 ? '#4caf50' : '#f44336';
			document.getElementById('stat-best-day').textContent = bestDay;
			document.getElementById('stat-best-day-amount').textContent = Utils.formatCurrency(bestDayAmount);
			document.getElementById('stat-peak-hour').textContent = peakHour;
			document.getElementById('stat-peak-hour-orders').textContent = `${peakHourOrders} pedidos`;

			// Renderizar gr√°ficas
			renderSalesChart();
			renderProductsChart();
			renderMonthlyChart();
			renderCategoryChart();

			// Renderizar pedidos en tiempo real
			const container = document.getElementById('dashboard-orders-realtime');
			const recentOrders = AppState.orders
				.filter(o => o.status === 'pending')
				.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
				.slice(0, 6);
			
			if (recentOrders.length === 0) {
				container.innerHTML = '<p class="text-center" style="color: var(--muted); padding: 40px;">No hay pedidos activos</p>';
			} else {
				container.innerHTML = `
					<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-top: 15px;">
						${recentOrders.map(order => `
							<div class="table-card" style="padding: 15px; cursor: pointer;" onclick="showSection('orders')">
								<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
									<div class="table-number" style="font-size: 18px;">Pedido #${order.id.substring(0, 6)}</div>
									<span class="badge badge-warning">Pendiente</span>
								</div>
								<div style="color: var(--muted); font-size: 13px; margin-bottom: 8px;">
									${Utils.formatDate(order.createdAt)}
								</div>
								<div style="margin-bottom: 10px;">
									${order.items.slice(0, 2).map(item => `
										<div style="font-size: 12px; color: var(--text);">‚Ä¢ ${item.quantity}x ${item.name}</div>
									`).join('')}
									${order.items.length > 2 ? `<div style="font-size: 12px; color: var(--muted);">+${order.items.length - 2} m√°s...</div>` : ''}
								</div>
								<div style="font-size: 20px; font-weight: 700; color: var(--accent); text-align: right;">
									${Utils.formatCurrency(order.total)}
								</div>
							</div>
						`).join('')}
					</div>
				`;
			}
		}

		// Variables para almacenar instancias de gr√°ficas
		let salesChartInstance = null;
		let productsChartInstance = null;

		// Gr√°fica de ventas √∫ltimos 7 d√≠as
		function renderSalesChart() {
			const canvas = document.getElementById('sales-chart');
			if (!canvas) return;

			const ctx = canvas.getContext('2d');
			
			// Destruir gr√°fica anterior si existe
			if (salesChartInstance) {
				salesChartInstance.destroy();
			}

			// Obtener √∫ltimos 7 d√≠as
			const last7Days = [];
			const salesByDay = {};
			for (let i = 6; i >= 0; i--) {
				const date = new Date();
				date.setDate(date.getDate() - i);
				const dateKey = Utils.getDateKey(date);
				last7Days.push(dateKey);
				salesByDay[dateKey] = 0;
			}

			// Calcular ventas por d√≠a
			AppState.orders.filter(o => o.status === 'completed').forEach(order => {
				const orderDate = Utils.getDateKeyFromISO(order.completedAt);
				if (salesByDay.hasOwnProperty(orderDate)) {
					let orderTotal = 0;
					order.items.forEach(item => {
						orderTotal += item.price * item.quantity;
					});
					salesByDay[orderDate] += orderTotal;
				}
			});

			// Preparar datos para la gr√°fica
			const labels = last7Days.map(dateKey => {
				const [year, month, day] = dateKey.split('-');
				return `${day}/${month}`;
			});
			const data = last7Days.map(dateKey => salesByDay[dateKey]);

			salesChartInstance = new Chart(ctx, {
				type: 'line',
				data: {
					labels: labels,
					datasets: [{
						label: 'Ventas',
						data: data,
						borderColor: 'rgb(76, 175, 80)',
						backgroundColor: 'rgba(76, 175, 80, 0.1)',
						tension: 0.4,
						fill: true
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: true,
					plugins: {
						legend: {
							display: false
						},
						tooltip: {
							callbacks: {
								label: function(context) {
									return Utils.formatCurrency(context.parsed.y);
								}
							}
						}
					},
					scales: {
						y: {
							beginAtZero: true,
							ticks: {
								callback: function(value) {
									return '$' + (value / 1000).toFixed(0) + 'k';
								}
							}
						}
					}
				}
			});
		}

		// Gr√°fica de productos m√°s vendidos
		function renderProductsChart() {
			const canvas = document.getElementById('products-chart');
			if (!canvas) return;

			const ctx = canvas.getContext('2d');
			
			// Destruir gr√°fica anterior si existe
			if (productsChartInstance) {
				productsChartInstance.destroy();
			}

			// Contar ventas por producto
			const productSales = {};
			AppState.orders.filter(o => o.status === 'completed').forEach(order => {
				order.items.forEach(item => {
					const productName = item.name;
					if (!productSales[productName]) {
						productSales[productName] = 0;
					}
					productSales[productName] += item.quantity;
				});
			});

			// Ordenar y obtener top 5
			const sortedProducts = Object.entries(productSales)
				.sort((a, b) => b[1] - a[1])
				.slice(0, 5);

			if (sortedProducts.length === 0) {
				// Mostrar mensaje si no hay datos
				ctx.font = '14px Arial';
				ctx.fillStyle = '#999';
				ctx.textAlign = 'center';
				ctx.fillText('No hay datos disponibles', canvas.width / 2, canvas.height / 2);
				return;
			}

			const labels = sortedProducts.map(([name]) => name);
			const data = sortedProducts.map(([, quantity]) => quantity);

			productsChartInstance = new Chart(ctx, {
				type: 'bar',
				data: {
					labels: labels,
					datasets: [{
						label: 'Unidades Vendidas',
						data: data,
						backgroundColor: [
							'rgba(255, 107, 53, 0.8)',
							'rgba(76, 175, 80, 0.8)',
							'rgba(33, 150, 243, 0.8)',
							'rgba(255, 193, 7, 0.8)',
							'rgba(156, 39, 176, 0.8)'
						],
						borderColor: [
							'rgb(255, 107, 53)',
							'rgb(76, 175, 80)',
							'rgb(33, 150, 243)',
							'rgb(255, 193, 7)',
							'rgb(156, 39, 176)'
						],
						borderWidth: 2
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: true,
					plugins: {
						legend: {
							display: false
						}
					},
					scales: {
						y: {
							beginAtZero: true,
							ticks: {
								stepSize: 1
							}
						}
					}
				}
			});
		}

		// Variables para las nuevas gr√°ficas
		let monthlyChartInstance = null;
		let categoryChartInstance = null;

		// Gr√°fica de evoluci√≥n mensual
		function renderMonthlyChart() {
			const canvas = document.getElementById('monthly-chart');
			if (!canvas) return;

			const ctx = canvas.getContext('2d');
			
			if (monthlyChartInstance) {
				monthlyChartInstance.destroy();
			}

			// Obtener √∫ltimos 6 meses
			const last6Months = [];
			const salesByMonth = {};
			for (let i = 5; i >= 0; i--) {
				const date = new Date();
				date.setMonth(date.getMonth() - i);
				const monthKey = Utils.getMonthKey(date);
				last6Months.push(monthKey);
				salesByMonth[monthKey] = 0;
			}

			// Calcular ventas por mes
			AppState.orders.filter(o => o.status === 'completed').forEach(order => {
				const orderMonth = Utils.getMonthKeyFromISO(order.completedAt);
				if (salesByMonth.hasOwnProperty(orderMonth)) {
					let orderTotal = 0;
					order.items.forEach(item => {
						orderTotal += item.price * item.quantity;
					});
					salesByMonth[orderMonth] += orderTotal;
				}
			});

			// Preparar datos
			const labels = last6Months.map(monthKey => {
				const [year, month] = monthKey.split('-');
				const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
				return monthNames[parseInt(month) - 1];
			});
			const data = last6Months.map(monthKey => salesByMonth[monthKey]);

			monthlyChartInstance = new Chart(ctx, {
				type: 'bar',
				data: {
					labels: labels,
					datasets: [{
						label: 'Ventas',
						data: data,
						backgroundColor: 'rgba(76, 175, 80, 0.6)',
						borderColor: 'rgb(76, 175, 80)',
						borderWidth: 2
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: true,
					plugins: {
						legend: {
							display: false
						},
						tooltip: {
							callbacks: {
								label: function(context) {
									return Utils.formatCurrency(context.parsed.y);
								}
							}
						}
					},
					scales: {
						y: {
							beginAtZero: true,
							ticks: {
								callback: function(value) {
									return '$' + (value / 1000).toFixed(0) + 'k';
								}
							}
						}
					}
				}
			});
		}

		// Gr√°fica de categor√≠as m√°s vendidas
		function renderCategoryChart() {
			const canvas = document.getElementById('category-chart');
			if (!canvas) return;

			const ctx = canvas.getContext('2d');
			
			if (categoryChartInstance) {
				categoryChartInstance.destroy();
			}

			// Contar ventas por categor√≠a
			const categorySales = {};
			AppState.orders.filter(o => o.status === 'completed').forEach(order => {
				order.items.forEach(item => {
					// Buscar la categor√≠a del producto
					const menuItem = AppState.menuItems.find(mi => mi.name === item.name);
					const category = menuItem?.category || 'Sin categor√≠a';
					
					if (!categorySales[category]) {
						categorySales[category] = 0;
					}
					categorySales[category] += item.quantity;
				});
			});

			// Ordenar y obtener top categor√≠as
			const sortedCategories = Object.entries(categorySales)
				.sort((a, b) => b[1] - a[1])
				.slice(0, 6);

			if (sortedCategories.length === 0) {
				ctx.font = '14px Arial';
				ctx.fillStyle = '#999';
				ctx.textAlign = 'center';
				ctx.fillText('No hay datos disponibles', canvas.width / 2, canvas.height / 2);
				return;
			}

			const labels = sortedCategories.map(([name]) => name);
			const data = sortedCategories.map(([, quantity]) => quantity);

			const colors = [
				'rgba(255, 107, 53, 0.7)',
				'rgba(76, 175, 80, 0.7)',
				'rgba(33, 150, 243, 0.7)',
				'rgba(255, 193, 7, 0.7)',
				'rgba(156, 39, 176, 0.7)',
				'rgba(233, 30, 99, 0.7)'
			];

			categoryChartInstance = new Chart(ctx, {
				type: 'doughnut',
				data: {
					labels: labels,
					datasets: [{
						data: data,
						backgroundColor: colors,
						borderColor: '#fff',
						borderWidth: 2
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: true,
					plugins: {
						legend: {
							position: 'right',
							labels: {
								boxWidth: 15,
								padding: 10
							}
						},
						tooltip: {
							callbacks: {
								label: function(context) {
									const label = context.label || '';
									const value = context.parsed || 0;
									const total = context.dataset.data.reduce((a, b) => a + b, 0);
									const percentage = ((value / total) * 100).toFixed(1);
									return `${label}: ${value} (${percentage}%)`;
								}
							}
						}
					}
				}
			});
		}

		// PEDIDOS
		function renderOrders() {
			const container = document.getElementById('orders-list');
			const activeOrders = AppState.orders.filter(o => o.status === 'pending');
			
			if (activeOrders.length === 0) {
				container.innerHTML = '<p class="text-center" style="color: var(--muted); padding: 40px;">No hay pedidos activos</p>';
				return;
			}

			container.innerHTML = activeOrders.map(order => {
				const hasCustomer = order.customerData && order.customerData.name;
			const orderLabel = hasCustomer 
				? 'üõçÔ∏è Pedido de ' + order.customerData.name 
				: 'üì¶ Pedido Cat√°logo Virtual';
				
				return `
				<div class="order-card">
					<div class="order-header">
						<div>
							<strong style="color: var(--accent);">${orderLabel}</strong>
							<div class="small">${Utils.formatDate(order.createdAt)}</div>
							${order.customerData ? `
								<div class="small" style="margin-top: 5px;">
									<strong>Cliente:</strong> ${order.customerData.name}<br>
									<strong>Tel:</strong> ${order.customerData.phone}<br>
									<strong>Direcci√≥n:</strong> ${order.customerData.address}
								</div>
							` : ''}
						</div>
						<div>
							<span class="badge badge-warning">Pendiente</span>
						</div>
					</div>
					<div class="order-items-list">
						${order.items.map(item => `
							<div class="order-item-line">
								<div>${item.quantity}x ${item.name} ${item.notes ? `<br><small style="color: var(--muted);">Nota: ${item.notes}</small>` : ''}</div>
								<div>${Utils.formatCurrency(item.price * item.quantity)}</div>
							</div>
						`).join('')}
					</div>
					<div style="text-align: right; font-size: 20px; font-weight: 700; color: var(--success); margin-top: 10px;">
						Total: ${Utils.formatCurrency(order.total)}
					</div>
					<div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
						<button class="btn btn-success" onclick="completeOrder('${order.id}')">‚úì Completar y Facturar</button>
						<button class="btn btn-danger" onclick="cancelOrder('${order.id}')">‚úï Cancelar</button>
						${order.customerData && order.customerData.phone ? `
							<button class="btn" style="background: #25D366; color: white; border: none;" onclick="contactCustomerWhatsApp('${order.id}')">üí¨ Contactar Cliente</button>
						` : ''}
					</div>
				</div>
			`;
			}).join('');
		}

		let isCompletingOrder = false;

		async function completeOrder(orderId) {
			if (isCompletingOrder) {
				return;
			}
			
			const order = AppState.orders.find(o => o.id === orderId);
			if (!order) {
				alert('‚ùå Pedido no encontrado');
				return;
			}

			const hasCustomer = order.customerData && order.customerData.name;
		const orderLabel = hasCustomer 
			? 'Pedido de ' + order.customerData.name 
			: 'Pedido Cat√°logo Virtual';

			// Confirmar con el usuario
			if (!confirm(`¬øCompletar pedido de ${orderLabel}?\nTotal: ${Utils.formatCurrency(order.total)}`)) {
				return;
			}

			isCompletingOrder = true;

			try {
				// Pausar auto-refresh durante la operaci√≥n
				if (autoRefreshInterval) {
					clearInterval(autoRefreshInterval);
				}

				// 1. Actualizar orden
				order.status = 'completed';
				order.completedAt = new Date().toISOString();

// 2. Generar PDF primero (no depende del servidor)
			const pdfData = await generateInvoicePDF(order);

			// 3. Crear transacci√≥n con PDF adjunto
			const transaction = {
				id: Utils.generateId(),
				orderId: order.id,
				tableNumber: order.tableNumber || 'Cat√°logo Virtual',
				amount: order.total,
				type: 'sale',
				date: new Date().toISOString(),
				concept: `${orderLabel} - ${order.items.length} productos`,
				invoicePDF: pdfData,
				customerData: order.customerData
			};
			AppState.transactions.push(transaction);

				// 4. Intentar guardar en servidor (no bloquear si falla)
				try {
					await Promise.all([
						API.save('orders', AppState.orders),
						API.save('transactions', AppState.transactions)
					]);
					
					// Si guard√≥ exitosamente, recargar datos
					await loadInitialData();
					alert('‚úÖ Pedido completado y guardado exitosamente');
				} catch (saveError) {
					console.error('Error guardando en servidor:', saveError);
					alert('‚ö†Ô∏è Pedido completado localmente.\n\nNo se pudo sincronizar con el servidor.\nLos datos se guardar√°n cuando haya conexi√≥n.');
				}

				// 5. Actualizar UI
				renderOrders();
				renderDashboard();
				renderTransactions();
				

			} catch (error) {
				console.error('Error completando orden:', error);
				alert('‚ùå ERROR AL COMPLETAR PEDIDO\n\n' + error.message);
				
			} finally {
				isCompletingOrder = false;
				// Reiniciar auto-refresh
				startAutoRefresh();
			}
		}

	let isCancellingOrder = false;

	async function cancelOrder(orderId) {
		if (isCancellingOrder) {
			return;
		}
		
		if (!confirm('¬øEst√°s seguro de cancelar este pedido?')) return;

		isCancellingOrder = true;

		try {
			// Pausar auto-refresh
			if (autoRefreshInterval) {
				clearInterval(autoRefreshInterval);
			}

			const order = AppState.orders.find(o => o.id === orderId);
			if (!order) {
				throw new Error('Pedido no encontrado');
			}

			// CANCELAR PEDIDO LOCALMENTE PRIMERO
			order.status = 'cancelled';

			// Actualizar UI inmediatamente
			renderOrders();
			renderDashboard();

			// INTENTAR GUARDAR EN SERVIDOR (NO BLOQUEANTE)
			try {
				await API.save('orders', AppState.orders);
				await loadInitialData();
				alert('‚úÖ Pedido cancelado y sincronizado con el servidor');
			} catch (saveError) {
				console.error('Error al sincronizar:', saveError);
				alert('‚ö†Ô∏è Pedido cancelado localmente.\n\nNo se pudo sincronizar con el servidor.\nLos cambios se guardar√°n cuando se restablezca la conexi√≥n.');
			}

		} catch (error) {
			console.error('Error cancelando orden:', error);
			alert('‚ùå ERROR AL CANCELAR PEDIDO\n\nError: ' + error.message);
		} finally {
			isCancellingOrder = false;
			startAutoRefresh();
		}
	}

	// Contactar cliente por WhatsApp
	function contactCustomerWhatsApp(orderId) {
		const order = AppState.orders.find(o => o.id === orderId);
		if (!order || !order.customerData || !order.customerData.phone) {
			alert('‚ö†Ô∏è No hay n√∫mero de tel√©fono para este pedido');
			return;
		}

		const customer = order.customerData;
		// Limpiar n√∫mero de tel√©fono (quitar espacios, guiones, par√©ntesis)
		const phone = customer.phone.replace(/[\s\-\(\)]/g, '');
		
		// Crear mensaje personalizado
		const orderDate = new Date(order.timestamp).toLocaleDateString('es-CO', {
			day: 'numeric',
			month: 'long',
			year: 'numeric'
		});
		
		const productsText = order.items.map(item => 
			`- ${item.name} x${item.quantity} (${Utils.formatCurrency(item.price * item.quantity)})`
		).join('\n');
		
		const message = `¬°Hola ${customer.name}! üëã\n\n` +
			`Te escribimos de *Go Green - Moda Circular* üåø\n\n` +
			`Queremos confirmar tu pedido del ${orderDate}:\n\n` +
			productsText + '\n\n' +
			`*Total: ${Utils.formatCurrency(order.total)}*\n\n` +
			`Direcci√≥n de entrega: ${customer.address || 'No especificada'}\n\n` +
			`¬øTodo est√° correcto? ¬øTienes alguna pregunta? üòä`;
		
		// Codificar mensaje para URL
		const encodedMessage = encodeURIComponent(message);
		
		// Abrir WhatsApp
		const whatsappUrl = `https://api.whatsapp.com/send?phone=${phone}&text=${encodedMessage}`;
		window.open(whatsappUrl, '_blank');
	}

	// MEN√ö CONFIG
		function renderMenuConfig() {
			const tbody = document.querySelector('#menu-table tbody');
			tbody.innerHTML = AppState.menuItems.map(item => {
				const cost = item.cost || 0;
				const profit = item.price - cost;
				const margin = item.price > 0 ? ((profit / item.price) * 100).toFixed(1) : 0;
				return `
					<tr>
						<td data-label="Producto">
							<div style="display: flex; align-items: center; gap: 10px;">
								${item.image ? `<img src="${item.image}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;">` : ''}
								<strong>${item.name}</strong>
							</div>
						</td>
						<td data-label="Descripci√≥n" style="max-width: 200px; color: var(--muted); font-size: 13px;">${item.description || '-'}</td>
						<td data-label="Categor√≠a"><span class="badge badge-info">${item.category}</span></td>
						<td data-label="Costo">${Utils.formatCurrency(cost)}</td>
						<td data-label="Precio"><strong>${Utils.formatCurrency(item.price)}</strong></td>
						<td data-label="Ganancia" style="color: ${profit > 0 ? 'var(--accent)' : '#999'}; font-weight: 600;">${Utils.formatCurrency(profit)}</td>
						<td data-label="Margen">
							<span class="badge" style="background: ${margin > 50 ? '#4caf50' : margin > 30 ? '#ff9800' : '#999'}; color: #fff; font-weight: 600;">
								${margin}%
							</span>
						</td>
						<td data-label="Estado">
							<button 
								class="btn btn-small" 
								onclick="toggleProductAvailability('${item.id}')" 
								style="background: ${item.available ? '#4caf50' : '#666'}; color: #fff; border: none; padding: 6px 14px; font-size: 12px; min-width: 90px;"
								title="${item.available ? 'Click para ocultar del men√∫' : 'Click para mostrar en el men√∫'}">
								${item.available ? 'üëÅÔ∏è Visible' : 'üö´ Oculto'}
							</button>
						</td>
						<td data-label="Acciones">
							<button class="btn btn-small btn-secondary" onclick="editMenuItem('${item.id}')" title="Editar producto">‚úèÔ∏è</button>
							<button class="btn btn-small btn-danger" onclick="deleteMenuItem('${item.id}')" title="Eliminar producto">üóëÔ∏è</button>
						</td>
					</tr>
				`;
			}).join('');
		}

		function openMenuItemModal(itemId = null) {
			if (itemId) {
				currentEditingMenuItem = AppState.menuItems.find(i => i.id === itemId);
				document.getElementById('menu-item-modal-title').textContent = 'Editar Producto';
				document.getElementById('item-name').value = currentEditingMenuItem.name;
				document.getElementById('item-description').value = currentEditingMenuItem.description || '';
				document.getElementById('item-category').value = currentEditingMenuItem.category;
				document.getElementById('item-cost').value = currentEditingMenuItem.cost || 0;
				document.getElementById('item-price').value = currentEditingMenuItem.price;
				document.getElementById('item-available').checked = currentEditingMenuItem.available;
				document.getElementById('item-image').value = currentEditingMenuItem.image || '';
				if (currentEditingMenuItem.image) {
					showImagePreview(currentEditingMenuItem.image);
				} else {
					clearImagePreview();
				}
				updateProfitPreview();
			} else {
				currentEditingMenuItem = null;
				document.getElementById('menu-item-modal-title').textContent = 'Nuevo Producto';
				document.getElementById('item-name').value = '';
				document.getElementById('item-description').value = '';
				document.getElementById('item-category').value = '';
				document.getElementById('item-cost').value = '0';
				document.getElementById('item-price').value = '';
				document.getElementById('item-available').checked = true;
				document.getElementById('item-image').value = '';
				document.getElementById('profit-preview').style.display = 'none';
				clearImagePreview();
			}
			document.getElementById('menu-item-modal').classList.add('show');
		}

		function closeMenuItemModal() {
			document.getElementById('menu-item-modal').classList.remove('show');
			currentEditingMenuItem = null;
		}

		function editMenuItem(itemId) {
			openMenuItemModal(itemId);
		}

		// Manejar carga de imagen
		function handleImageUpload(input) {
			if (input.files && input.files[0]) {
				const reader = new FileReader();
				reader.onload = function(e) {
					const imageData = e.target.result;
					document.getElementById('item-image').value = imageData;
					showImagePreview(imageData);
				};
				reader.readAsDataURL(input.files[0]);
			}
		}

		function showImagePreview(imageUrl) {
			if (!imageUrl) {
				document.getElementById('item-image-preview').innerHTML = '';
				return;
			}
			document.getElementById('item-image-preview').innerHTML = `
				<div style="position: relative; display: inline-block;">
					<img src="${imageUrl}" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 2px solid var(--accent);">
					<button onclick="clearImagePreview()" style="position: absolute; top: 5px; right: 5px; background: var(--danger); color: #fff; border: 0; border-radius: 50%; width: 25px; height: 25px; cursor: pointer;">‚úï</button>
				</div>
			`;
		}

		function clearImagePreview() {
			document.getElementById('item-image').value = '';
			document.getElementById('item-image-file').value = '';
			document.getElementById('item-image-preview').innerHTML = '';
		}

		function updateProfitPreview() {
			const cost = parseFloat(document.getElementById('item-cost').value) || 0;
			const price = parseFloat(document.getElementById('item-price').value) || 0;
			
			if (price > 0 && cost >= 0) {
				const profit = price - cost;
				const margin = ((profit / price) * 100).toFixed(1);
				
				document.getElementById('profit-amount').textContent = Utils.formatCurrency(profit);
				document.getElementById('profit-margin').textContent = margin + '%';
				document.getElementById('profit-preview').style.display = 'block';
			} else {
				document.getElementById('profit-preview').style.display = 'none';
			}
		}

		async function saveMenuItem() {
			const name = document.getElementById('item-name').value.trim();
			const description = document.getElementById('item-description').value.trim();
			const category = document.getElementById('item-category').value.trim();
			const cost = parseFloat(document.getElementById('item-cost').value) || 0;
			const price = parseFloat(document.getElementById('item-price').value);
			const available = document.getElementById('item-available').checked;
			const image = document.getElementById('item-image').value.trim();

			if (!name || !category || !price) {
				Utils.showNotification('Completa los campos requeridos', 'warning');
				return;
			}

			if (currentEditingMenuItem) {
				currentEditingMenuItem.name = name;
				currentEditingMenuItem.description = description;
				currentEditingMenuItem.category = category;
				currentEditingMenuItem.cost = cost;
				currentEditingMenuItem.price = price;
				currentEditingMenuItem.available = available;
				currentEditingMenuItem.image = image;
				const index = AppState.menuItems.findIndex(i => i.id === currentEditingMenuItem.id);
				AppState.menuItems[index] = currentEditingMenuItem;
			} else {
				AppState.menuItems.push({
					id: Utils.generateId(),
					name,
					description,
					category,
					cost,
					price,
					available,
					image
				});
			}

			await API.save('menu_items', AppState.menuItems);
			closeMenuItemModal();
			renderMenuConfig();
			Utils.showNotification('Producto guardado', 'success');
		}

		async function deleteMenuItem(itemId) {
			if (!confirm('¬øEliminar este producto?')) return;
			AppState.menuItems = AppState.menuItems.filter(i => i.id !== itemId);
			await API.save('menu_items', AppState.menuItems);
			renderMenuConfig();
			Utils.showNotification('Producto eliminado', 'success');
		}

		async function toggleProductAvailability(itemId) {
			const item = AppState.menuItems.find(i => i.id === itemId);
			if (!item) return;
			
			// Cambiar el estado
			item.available = !item.available;
			
			// Actualizar UI inmediatamente
			renderMenuConfig();
			
			// Guardar en servidor en segundo plano
			API.save('menu_items', AppState.menuItems).catch(error => {
				console.error('Error guardando disponibilidad:', error);
				// Revertir cambio si falla
				item.available = !item.available;
				renderMenuConfig();
				alert('‚ö†Ô∏è Error al actualizar. Intenta de nuevo.');
			});
		}

		// TRANSACCIONES
		function renderTransactions() {
			const tbody = document.querySelector('#transactions-table tbody');
			const sorted = [...AppState.transactions].sort((a, b) => 
				new Date(b.date) - new Date(a.date)
			);
			
			if (sorted.length === 0) {
				tbody.innerHTML = '<tr><td colspan="5" class="text-center" style="color: var(--muted); padding: 40px;">No hay transacciones registradas</td></tr>';
				return;
			}

			tbody.innerHTML = sorted.map(t => `
				<tr>
					<td data-label="Fecha">${Utils.formatDate(t.date)}</td>
					<td data-label="Pedido">${t.tableNumber || '-'}</td>
					<td data-label="Concepto">
						${t.concept}
						${t.customerData ? `<br><small style="color: var(--muted);">Cliente: ${t.customerData.name}</small>` : ''}
					</td>
					<td data-label="Monto" style="color: var(--success); font-weight: 600;">${Utils.formatCurrency(t.amount)}</td>
					<td data-label="Acciones" style="display: flex; gap: 5px;">
						${t.invoicePDF ? `<button class="btn btn-small" style="background: var(--accent);" onclick="viewInvoice('${t.id}')">üìÑ Factura</button>` : ''}
					</td>
				</tr>
			`).join('');
		}

		async function deleteTransaction(transactionId) {
			if (!confirm('¬øEliminar esta transacci√≥n?')) return;
			AppState.transactions = AppState.transactions.filter(t => t.id !== transactionId);
			await API.save('transactions', AppState.transactions);
			renderTransactions();
			renderDashboard();
			Utils.showNotification('Transacci√≥n eliminada', 'success');
		}


	function viewInvoice(transactionId) {
		const transaction = AppState.transactions.find(t => t.id === transactionId);
		console.log('Transaction found:', transaction);
		console.log('Invoice PDF exists:', !!transaction?.invoicePDF);
		console.log('PDF size:', transaction?.invoicePDF?.length);
		
		if (!transaction || !transaction.invoicePDF) {
			alert('Factura no disponible');
			return;
		}
		
		// Abrir PDF en nueva pesta√±a
		const pdfWindow = window.open('', '_blank');
		if (pdfWindow) {
			pdfWindow.document.write('<iframe width="100%" height="100%" src="' + transaction.invoicePDF + '"></iframe>');
		} else {
			alert('Por favor permite las ventanas emergentes para ver la factura');
		}
	}

		// VER DETALLE DE MESA
		// MODAL DE PEDIDOS
		let currentOrderTable = null;
		let currentOrderItems = [];

		function openOrderModal(tableId) {
			const table = AppState.tables.find(t => t.id === tableId);
			if (!table) return;

			currentOrderTable = table;
			
			// Si la mesa ya tiene un pedido, cargar sus items
			if (table.currentOrder) {
				const existingOrder = AppState.orders.find(o => o.id === table.currentOrder);
				if (existingOrder) {
					currentOrderItems = JSON.parse(JSON.stringify(existingOrder.items));
				}
			} else {
				currentOrderItems = [];
			}

			document.getElementById('order-modal-title').textContent = `Mesa ${table.number} - ${table.currentOrder ? 'Editar' : 'Nuevo'} Pedido`;
			renderOrderModalMenu();
			updateOrderSummary();
			document.getElementById('order-modal').classList.add('show');
		}

		function closeOrderModal() {
			document.getElementById('order-modal').classList.remove('show');
			currentOrderTable = null;
			currentOrderItems = [];
		}

		function renderOrderModalMenu() {
			const categories = [...new Set(AppState.menuItems.filter(i => i.available).map(i => i.category))];
			const container = document.getElementById('order-menu-items');
			
			container.innerHTML = categories.map(category => `
				<div style="margin-bottom: 25px;">
					<h4 style="color: var(--accent); margin-bottom: 15px; border-bottom: 2px solid var(--accent); padding-bottom: 8px;">${category}</h4>
					<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
						${AppState.menuItems
							.filter(item => item.category === category && item.available)
							.map(item => `
								<div class="menu-item-btn" onclick="addItemToOrder('${item.id}')" style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent;" onmouseover="this.style.borderColor='var(--accent)'; this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.borderColor='transparent'; this.style.background='rgba(255,255,255,0.05)'">
									<div style="font-weight: 600; margin-bottom: 5px;">${item.name}</div>
									<div style="color: var(--accent); font-size: 18px; font-weight: 700;">${Utils.formatCurrency(item.price)}</div>
								</div>
							`).join('')}
					</div>
				</div>
			`).join('');
		}

		function addItemToOrder(itemId) {
			const menuItem = AppState.menuItems.find(i => i.id === itemId);
			if (!menuItem) return;

			const existingItem = currentOrderItems.find(i => i.menuItemId === itemId && !i.notes);
			
			if (existingItem) {
				existingItem.quantity++;
			} else {
				currentOrderItems.push({
					menuItemId: itemId,
					name: menuItem.name,
					price: menuItem.price,
					quantity: 1,
					notes: ''
				});
			}

			updateOrderSummary();
		}

		function updateOrderSummary() {
			const container = document.getElementById('order-items-summary');
			
			if (currentOrderItems.length === 0) {
				container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 20px;">No hay productos en el pedido</p>';
				document.getElementById('order-total-amount').textContent = Utils.formatCurrency(0);
				return;
			}

			const total = currentOrderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
			
			container.innerHTML = currentOrderItems.map((item, index) => `
				<div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--accent);">
					<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
						<strong>${item.name}</strong>
						<button class="btn btn-small btn-danger" onclick="removeItemFromOrder(${index})" style="padding: 4px 8px;">üóëÔ∏è</button>
					</div>
					<div style="display: flex; gap: 10px; align-items: center;">
						<button onclick="changeQuantity(${index}, -1)" style="width: 30px; height: 30px; border-radius: 50%; border: 0; background: #ffffff; color: #000000; cursor: pointer; font-size: 18px;">-</button>
						<span style="font-size: 18px; font-weight: 700; min-width: 30px; text-align: center;">${item.quantity}</span>
						<button onclick="changeQuantity(${index}, 1)" style="width: 30px; height: 30px; border-radius: 50%; border: 0; background: #ffffff; color: #000000; cursor: pointer; font-size: 18px;">+</button>
						<span style="margin-left: auto; color: var(--accent); font-weight: 700;">${Utils.formatCurrency(item.price * item.quantity)}</span>
					</div>
					<textarea placeholder="Notas especiales..." onchange="updateItemNotes(${index}, this.value)" style="width: 100%; margin-top: 8px; min-height: 40px; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--text); font-size: 13px;">${item.notes || ''}</textarea>
				</div>
			`).join('');
			
			document.getElementById('order-total-amount').textContent = Utils.formatCurrency(total);
		}

		function changeQuantity(index, delta) {
			if (currentOrderItems[index]) {
				currentOrderItems[index].quantity += delta;
				if (currentOrderItems[index].quantity <= 0) {
					currentOrderItems.splice(index, 1);
				}
				updateOrderSummary();
			}
		}

		function removeItemFromOrder(index) {
			currentOrderItems.splice(index, 1);
			updateOrderSummary();
		}

		function updateItemNotes(index, notes) {
			if (currentOrderItems[index]) {
				currentOrderItems[index].notes = notes;
			}
		}

	let isSavingOrder = false;

	async function saveOrderFromModal() {
		if (isSavingOrder) {
			return;
		}
		
		if (!currentOrderTable || currentOrderItems.length === 0) {
			alert('‚ö†Ô∏è Agrega al menos un producto');
			return;
		}

		isSavingOrder = true;

		try {
			// Pausar auto-refresh
			if (autoRefreshInterval) {
				clearInterval(autoRefreshInterval);
			}

			const total = currentOrderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);

			// Encontrar la mesa en el estado global
			const tableInState = AppState.tables.find(t => t.id === currentOrderTable.id);
			if (!tableInState) {
				throw new Error('Mesa no encontrada');
			}

			if (tableInState.currentOrder) {
				// Actualizar pedido existente
				const order = AppState.orders.find(o => o.id === tableInState.currentOrder);
				if (order) {
					order.items = [...currentOrderItems];
					order.total = total;
					order.updatedAt = new Date().toISOString();
				}
			} else {
				// Crear nuevo pedido
				const newOrder = {
					id: Utils.generateId(),
					tableId: tableInState.id,
					tableNumber: tableInState.number,
					items: [...currentOrderItems],
					total: total,
					status: 'pending',
					createdAt: new Date().toISOString()
				};
				AppState.orders.push(newOrder);
				
				// Actualizar la mesa en el estado global
				tableInState.currentOrder = newOrder.id;
				tableInState.status = 'occupied';
			}

			// GUARDAR EN SERVIDOR Y ESPERAR CONFIRMACI√ìN
			await Promise.all([
				API.save('orders', AppState.orders),
				API.save('tables', AppState.tables)
			]);

			// RECARGAR desde servidor para garantizar sincronizaci√≥n
			await loadInitialData();

			// Cerrar modal y actualizar UI
			closeOrderModal();
			renderAllSections();

		} catch (error) {
			console.error('Error guardando pedido:', error);
			
			// Intentar recargar datos
			try {
				await loadInitialData();
				renderAllSections();
			} catch (loadError) {
				console.error('No se pudo recargar datos:', loadError);
			}
			
			alert('‚ùå ERROR AL GUARDAR PEDIDO\n\nNo se pudo guardar en el servidor.\nVerifica tu conexi√≥n e intenta nuevamente.');
			
		} finally {
			isSavingOrder = false;
			startAutoRefresh();
		}
	}		function viewTableDetails(tableId) {
			const table = AppState.tables.find(t => t.id === tableId);
			if (!table || !table.currentOrder) return;

			const order = AppState.orders.find(o => o.id === table.currentOrder);
			if (!order) return;

			document.getElementById('table-detail-title').textContent = `Mesa ${table.number} - Detalle`;
			
			const content = document.getElementById('table-detail-content');
			content.innerHTML = `
				<div style="margin-bottom: 20px;">
					<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
						<div>
							<strong style="color: var(--accent); font-size: 18px;">Mesa ${table.number}</strong>
							<div class="small" style="color: var(--muted);">${Utils.formatDate(order.createdAt)}</div>
						</div>
						<span class="badge badge-warning">Activo</span>
					</div>
					
					<div class="order-items-list" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
						<h4 style="color: var(--accent); margin-bottom: 10px;">Productos</h4>
						${order.items.map(item => `
							<div class="order-item-line" style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
								<div>
									<strong>${item.quantity}x ${item.name}</strong>
									${item.notes ? `<br><small style="color: var(--muted); font-size: 12px;">Nota: ${item.notes}</small>` : ''}
								</div>
								<div style="color: var(--success); font-weight: 600;">
									${Utils.formatCurrency(item.price * item.quantity)}
								</div>
							</div>
						`).join('')}
					</div>
					
					<div style="text-align: right; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; border: 2px solid var(--success);">
						<div style="font-size: 14px; color: var(--muted); margin-bottom: 5px;">Total a Pagar</div>
						<div style="font-size: 28px; font-weight: 700; color: var(--success);">
							${Utils.formatCurrency(order.total)}
						</div>
					</div>
					
					<div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
						<button class="btn btn-warning" onclick="generateInvoicePDFFromModal('${order.id}')">üìÑ Generar PDF</button>
						<button class="btn btn-success" onclick="completeOrderFromModal('${order.id}')">‚úì Completar y Facturar</button>
						<button class="btn btn-secondary" onclick="closeTableDetailModal()">Cerrar</button>
					</div>
				</div>
			`;
			
			document.getElementById('table-detail-modal').classList.add('show');
		}

		function closeTableDetailModal() {
			document.getElementById('table-detail-modal').classList.remove('show');
		}

		async function generateInvoicePDFFromModal(orderId) {
			const order = AppState.orders.find(o => o.id === orderId);
			if (order) {
				await generateInvoicePDF(order);
				Utils.showNotification('PDF generado', 'success');
			}
		}

		async function completeOrderFromModal(orderId) {
			closeTableDetailModal();
			await completeOrder(orderId);
		}

		// CIERRE DE CAJA
		async function generateCloseCash() {
			const today = Utils.getDateKey();
			const todayTransactions = AppState.transactions.filter(t => Utils.getDateKeyFromISO(t.date) === today);
			
			const totalSales = todayTransactions.reduce((sum, t) => sum + (t.amount || 0), 0);
			const totalOrders = todayTransactions.length;
			const completedOrders = AppState.orders.filter(o => 
				o.status === 'completed' && Utils.getDateKeyFromISO(o.completedAt) === today
			).length;

			const container = document.getElementById('close-cash-content');
			container.innerHTML = `
				<div class="close-cash-summary">
					<h2>Cierre de Caja - ${new Date().toLocaleDateString('es-MX')}</h2>
					<div class="close-cash-line">
						<span>Total de Ventas:</span>
						<span>${totalOrders}</span>
					</div>
					<div class="close-cash-line">
						<span>Pedidos Completados:</span>
						<span>${completedOrders}</span>
					</div>
					<div class="close-cash-line">
						<span>Ingreso Bruto:</span>
						<span>${Utils.formatCurrency(totalSales)}</span>
					</div>
					<div class="close-cash-total">
						Total del D√≠a: ${Utils.formatCurrency(totalSales)}
					</div>
					<div style="margin-top: 20px; display: flex; gap: 10px;">
						<button class="btn" onclick="generateCloseCashPDF()">üìÑ Ver PDF</button>
						<button class="btn btn-success" onclick="saveCloseCash()">üíæ Guardar Cierre</button>
					</div>
				</div>
			`;

			document.getElementById('closure-history').style.display = 'none';
		}

		async function saveCloseCash() {
			const today = Utils.getDateKey();
			const todayTransactions = AppState.transactions.filter(t => Utils.getDateKeyFromISO(t.date) === today);
			
			// Verificar si ya existe un cierre para hoy
			const existingClosure = AppState.cashClosures.find(c => c.date === today);
			if (existingClosure) {
				if (!confirm('Ya existe un cierre para hoy. ¬øDeseas actualizarlo?')) return;
			}

			const totalSales = todayTransactions.reduce((sum, t) => sum + (t.amount || 0), 0);
			const completedOrders = AppState.orders.filter(o => 
				o.status === 'completed' && Utils.getDateKeyFromISO(o.completedAt) === today
			).length;

			const closure = {
				id: existingClosure ? existingClosure.id : Utils.generateId(),
				date: today,
				totalTransactions: todayTransactions.length,
				totalSales: totalSales,
				completedOrders: completedOrders,
				transactions: todayTransactions,
				createdAt: existingClosure ? existingClosure.createdAt : new Date().toISOString(),
				updatedAt: new Date().toISOString()
			};

			if (existingClosure) {
				const index = AppState.cashClosures.findIndex(c => c.id === closure.id);
				AppState.cashClosures[index] = closure;
			} else {
				AppState.cashClosures.push(closure);
			}

			await API.save('cash_closures', AppState.cashClosures);
			Utils.showNotification('Cierre de caja guardado correctamente', 'success');
		}

		function viewClosureHistory() {
			document.getElementById('close-cash-content').innerHTML = `
				<p class="text-center" style="color: var(--muted); padding: 40px;">
					Selecciona "Generar Cierre Actual" para ver el resumen del d√≠a o revisa el historial abajo
				</p>
			`;
			
			const historyDiv = document.getElementById('closure-history');
			historyDiv.style.display = 'block';
			
			const tbody = document.querySelector('#closures-table tbody');
			const sorted = [...AppState.cashClosures].sort((a, b) => 
				new Date(b.date) - new Date(a.date)
			);
			
			if (sorted.length === 0) {
				tbody.innerHTML = '<tr><td colspan="4" class="text-center" style="color: var(--muted); padding: 40px;">No hay cierres guardados</td></tr>';
				return;
			}

			tbody.innerHTML = sorted.map(closure => `
				<tr>
					<td>${new Date(closure.date).toLocaleDateString('es-MX')}</td>
					<td>${closure.totalTransactions} ventas</td>
					<td style="color: var(--success); font-weight: 600;">${Utils.formatCurrency(closure.totalSales)}</td>
					<td>
						<button class="btn btn-small btn-warning" onclick="viewClosureDetail('${closure.id}')">üëÅÔ∏è Ver</button>
						<button class="btn btn-small btn-secondary" onclick="generateClosurePDF('${closure.id}')">üìÑ PDF</button>
						<button class="btn btn-small btn-danger" onclick="deleteClosure('${closure.id}')">üóëÔ∏è</button>
					</td>
				</tr>
			`).join('');
		}

		function viewClosureDetail(closureId) {
			const closure = AppState.cashClosures.find(c => c.id === closureId);
			if (!closure) return;

			const container = document.getElementById('close-cash-content');
			container.innerHTML = `
				<div class="close-cash-summary">
					<h2>Cierre de Caja - ${new Date(closure.date).toLocaleDateString('es-MX')}</h2>
					<div class="close-cash-line">
						<span>Total de Ventas:</span>
						<span>${closure.totalTransactions}</span>
					</div>
					<div class="close-cash-line">
						<span>Pedidos Completados:</span>
						<span>${closure.completedOrders}</span>
					</div>
					<div class="close-cash-line">
						<span>Ingreso Bruto:</span>
						<span>${Utils.formatCurrency(closure.totalSales)}</span>
					</div>
					<div class="close-cash-total">
						Total del D√≠a: ${Utils.formatCurrency(closure.totalSales)}
					</div>
					<div style="margin-top: 20px;">
						<button class="btn" onclick="generateClosurePDF('${closure.id}')">üìÑ Ver PDF</button>
					</div>
				</div>
			`;

			window.scrollTo({ top: 0, behavior: 'smooth' });
		}

		function generateClosurePDF(closureId) {
			const closure = AppState.cashClosures.find(c => c.id === closureId);
			if (!closure) return;

			const { jsPDF } = window.jspdf;
			const doc = new jsPDF();
			
			doc.setFontSize(20);
			doc.text('CIERRE DE CAJA', 105, 20, { align: 'center' });
			doc.setFontSize(12);
			doc.text(`Fecha: ${new Date(closure.date).toLocaleDateString('es-MX')}`, 105, 30, { align: 'center' });
			
			doc.setLineWidth(0.5);
			doc.line(20, 35, 190, 35);
			
			let y = 48;
			doc.setFontSize(14);
			doc.text('Resumen del D√≠a', 20, y);
			y += 10;
			
			doc.setFontSize(11);
			doc.text(`Total de Transacciones: ${closure.totalTransactions}`, 20, y);
			y += 8;
			doc.text(`Pedidos Completados: ${closure.completedOrders}`, 20, y);
			y += 8;
			doc.text(`Ingresos Totales: ${Utils.formatCurrency(closure.totalSales)}`, 20, y);
			y += 15;
			
			if (closure.transactions && closure.transactions.length > 0) {
				doc.setFontSize(14);
				doc.text('Detalle de Transacciones', 20, y);
				y += 8;
				
				doc.setFontSize(9);
				closure.transactions.forEach(t => {
					if (y > 270) {
						doc.addPage();
						y = 20;
					}
					doc.text(`${new Date(t.date).toLocaleTimeString('es-MX')} - Mesa ${t.tableNumber || '-'} - ${Utils.formatCurrency(t.amount)}`, 20, y);
					y += 6;
				});
			}
			
			const pdfBlob = doc.output('blob');
			const pdfUrl = URL.createObjectURL(pdfBlob);
			window.open(pdfUrl, '_blank');
		}

		async function deleteClosure(closureId) {
			if (!confirm('¬øEliminar este cierre de caja?')) return;
			AppState.cashClosures = AppState.cashClosures.filter(c => c.id !== closureId);
			await API.save('cash_closures', AppState.cashClosures);
			viewClosureHistory();
			Utils.showNotification('Cierre eliminado', 'success');
		}

		// GENERAR PDF FACTURA
		async function generateInvoicePDF(order) {
			try {
				const { jsPDF } = window.jspdf;
				const doc = new jsPDF({
				orientation: 'portrait',
				unit: 'mm',
				format: 'a4'
			});

			const pageWidth = doc.internal.pageSize.getWidth();
			const pageHeight = doc.internal.pageSize.getHeight();
			const margin = 20;

			// ENCABEZADO CON FONDO VERDE
			doc.setFillColor(45, 105, 67); // Verde Go Green
			doc.rect(0, 0, pageWidth, 45, 'F');

		// Cargar y agregar el logo
		const logoImg = new Image();
		logoImg.src = '/image.png';
		await new Promise((resolve) => {
			logoImg.onload = () => {
				try {
					// Crear canvas temporal para recortar en c√≠rculo (reducido a 100x100)
					const canvas = document.createElement('canvas');
					const size = 100;
					canvas.width = size;
					canvas.height = size;
					const ctx = canvas.getContext('2d');
					
					// Dibujar c√≠rculo y usar como m√°scara
					ctx.beginPath();
					ctx.arc(size/2, size/2, size/2, 0, Math.PI * 2);
					ctx.closePath();
					ctx.clip();
					
					// Dibujar imagen dentro del c√≠rculo
					ctx.drawImage(logoImg, 0, 0, size, size);
					
					// Agregar logo circular comprimido (20x20mm para reducir tama√±o)
					const circularLogo = canvas.toDataURL('image/jpeg', 0.7);
					doc.addImage(circularLogo, 'JPEG', 20, 12, 20, 20);
				} catch (e) {
					console.log('Error cargando logo:', e);
				}
				resolve();
			};
			logoImg.onerror = () => {
				console.log('Logo no encontrado');
				resolve();
			};
		});

		// T√≠tulo empresa (color pastel beige/crema)
		doc.setTextColor(245, 235, 220); // Color beige pastel
		doc.setFontSize(28);
		doc.setFont(undefined, 'bold');
		doc.text('GO GREEN', 50, 22);
		doc.setFontSize(12);
		doc.setFont(undefined, 'normal');
		doc.text('Moda Circular', 50, 30);

			// FACTURA texto derecha
			doc.setFontSize(20);
			doc.setFont(undefined, 'bold');
			doc.text('FACTURA', pageWidth - margin, 25, { align: 'right' });
			doc.setFontSize(10);
			doc.setFont(undefined, 'normal');
			doc.text(`N¬∞ ${order.id.substring(0, 8).toUpperCase()}`, pageWidth - margin, 32, { align: 'right' });

			// Resetear color texto
			doc.setTextColor(0, 0, 0);

			// INFORMACI√ìN DEL PEDIDO
			let yPos = 60;
			doc.setFontSize(11);
			doc.setFont(undefined, 'bold');
			doc.text('Fecha:', margin, yPos);
			doc.setFont(undefined, 'normal');
			doc.text(new Date(order.createdAt).toLocaleString('es-CO', { 
				year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' 
			}), margin + 20, yPos);

			// DATOS DEL CLIENTE
			if (order.customerData) {
				yPos += 15;
				doc.setFillColor(245, 245, 245);
				doc.rect(margin, yPos - 5, pageWidth - 2 * margin, 30, 'F');
				
				doc.setFontSize(12);
				doc.setFont(undefined, 'bold');
				doc.setTextColor(45, 105, 67);
				doc.text('DATOS DEL CLIENTE', margin + 5, yPos + 2);
				
				doc.setTextColor(0, 0, 0);
				doc.setFontSize(10);
				doc.setFont(undefined, 'normal');
				yPos += 10;
				doc.text(`Nombre: ${order.customerData.name}`, margin + 5, yPos);
				yPos += 6;
				doc.text(`Tel√©fono: ${order.customerData.phone}`, margin + 5, yPos);
				if (order.customerData.email) {
					yPos += 6;
					doc.text(`Email: ${order.customerData.email}`, margin + 5, yPos);
				}
				if (order.customerData.address) {
					yPos += 6;
					doc.text(`Direcci√≥n: ${order.customerData.address}`, margin + 5, yPos);
				}
				yPos += 15;
			} else {
				yPos += 10;
			}

			// TABLA DE PRODUCTOS
			doc.setFontSize(12);
			doc.setFont(undefined, 'bold');
			doc.setTextColor(45, 105, 67);
			doc.text('DETALLE DEL PEDIDO', margin, yPos);
			yPos += 8;

			// Encabezado tabla
			doc.setFillColor(45, 105, 67);
			doc.rect(margin, yPos - 5, pageWidth - 2 * margin, 10, 'F');
			doc.setTextColor(255, 255, 255);
			doc.setFontSize(10);
			doc.setFont(undefined, 'bold');
			doc.text('Cant.', margin + 3, yPos);
			doc.text('Producto', margin + 20, yPos);
			doc.text('Precio Unit.', pageWidth - margin - 55, yPos);
			doc.text('Total', pageWidth - margin - 3, yPos, { align: 'right' });

			// Items
			yPos += 10;
			doc.setTextColor(0, 0, 0);
			doc.setFont(undefined, 'normal');
			let alternate = false;
			
			order.items.forEach(item => {
				if (alternate) {
					doc.setFillColor(250, 250, 250);
					doc.rect(margin, yPos - 5, pageWidth - 2 * margin, 8, 'F');
				}
				alternate = !alternate;

				doc.text(item.quantity.toString(), margin + 8, yPos, { align: 'center' });
				doc.text(item.name, margin + 20, yPos);
				doc.text(`$${item.price.toLocaleString('es-CO')}`, pageWidth - margin - 55, yPos);
				doc.text(`$${(item.price * item.quantity).toLocaleString('es-CO')}`, pageWidth - margin - 3, yPos, { align: 'right' });
				
				yPos += 8;
				
				if (item.notes) {
					doc.setFontSize(8);
					doc.setTextColor(100, 100, 100);
					doc.text(`Nota: ${item.notes}`, margin + 20, yPos - 2);
					doc.setFontSize(10);
					doc.setTextColor(0, 0, 0);
					yPos += 5;
				}
			});

			// TOTAL
			yPos += 10;
			doc.setDrawColor(45, 105, 67);
			doc.setLineWidth(0.5);
			doc.line(margin, yPos, pageWidth - margin, yPos);
			
			yPos += 10;
			doc.setFontSize(16);
			doc.setFont(undefined, 'bold');
			doc.setTextColor(45, 105, 67);
			doc.text('TOTAL:', pageWidth - margin - 60, yPos);
			doc.text(`$${order.total.toLocaleString('es-CO')}`, pageWidth - margin - 3, yPos, { align: 'right' });

			// PIE DE P√ÅGINA
			doc.setFillColor(245, 245, 245);
			doc.rect(0, pageHeight - 30, pageWidth, 30, 'F');
			doc.setFontSize(10);
			doc.setFont(undefined, 'normal');
			doc.setTextColor(100, 100, 100);
			doc.text('Gracias por tu compra', pageWidth / 2, pageHeight - 20, { align: 'center' });
			doc.setFontSize(9);
			doc.text('Go Green - Moda Circular | Comprometidos con el medio ambiente', pageWidth / 2, pageHeight - 14, { align: 'center' });
			doc.text('¬øDudas? Cont√°ctanos al WhatsApp: +57 322 778 1179', pageWidth / 2, pageHeight - 9, { align: 'center' });

// Generar PDF y retornar base64
		const pdfBase64 = doc.output('dataurlstring');
		
		// Abrir en nueva pesta√±a
		const pdfBlob = doc.output('blob');
		const pdfUrl = URL.createObjectURL(pdfBlob);
		window.open(pdfUrl, '_blank');
		
		return pdfBase64;
	} catch (error) {
		console.error('Error generando PDF:', error);
		// No detener el flujo si falla el PDF
		return null;
		}
	}

		// GENERAR PDF CIERRE DE CAJA
		function generateCloseCashPDF() {
			const { jsPDF } = window.jspdf;
			const doc = new jsPDF();
			
			const today = Utils.getDateKey();
			const todayTransactions = AppState.transactions.filter(t => Utils.getDateKeyFromISO(t.date) === today);
			const totalSales = todayTransactions.reduce((sum, t) => sum + (t.amount || 0), 0);
			
			doc.setFontSize(20);
			doc.text('CIERRE DE CAJA', 105, 20, { align: 'center' });
			doc.setFontSize(12);
			doc.text(`Fecha: ${new Date().toLocaleDateString('es-MX')}`, 105, 30, { align: 'center' });
			doc.text(`Hora: ${new Date().toLocaleTimeString('es-MX')}`, 105, 37, { align: 'center' });
			
			doc.setLineWidth(0.5);
			doc.line(20, 42, 190, 42);
			
			let y = 55;
			doc.setFontSize(14);
			doc.text('Resumen del D√≠a', 20, y);
			y += 10;
			
			doc.setFontSize(11);
			doc.text(`Total de Transacciones: ${todayTransactions.length}`, 20, y);
			y += 8;
			doc.text(`Ingresos Totales: ${Utils.formatCurrency(totalSales)}`, 20, y);
			y += 15;
			
			doc.setFontSize(14);
			doc.text('Detalle de Transacciones', 20, y);
			y += 8;
			
			doc.setFontSize(9);
			todayTransactions.forEach(t => {
				if (y > 270) {
					doc.addPage();
					y = 20;
				}
				doc.text(`${new Date(t.date).toLocaleTimeString('es-MX')} - Mesa ${t.tableNumber || '-'} - ${Utils.formatCurrency(t.amount)}`, 20, y);
				y += 6;
			});
			
			// Abrir en nueva pesta√±a para visualizar
			const pdfBlob = doc.output('blob');
			const pdfUrl = URL.createObjectURL(pdfBlob);
			window.open(pdfUrl, '_blank');
		}

		// Funciones para men√∫ m√≥vil
		function toggleMobileMenu() {
			const sidebar = document.getElementById('sidebar');
			const overlay = document.querySelector('.mobile-overlay');
			sidebar.classList.toggle('mobile-open');
			overlay.classList.toggle('active');
		}
		
		function closeMobileMenu() {
			const sidebar = document.getElementById('sidebar');
			const overlay = document.querySelector('.mobile-overlay');
			sidebar.classList.remove('mobile-open');
			overlay.classList.remove('active');
		}
		
		// CONFIGURACI√ìN DEL SISTEMA
		async function resetSalesData() {
			const confirmation = prompt(
				'‚ö†Ô∏è ADVERTENCIA: Esta acci√≥n eliminar√° TODOS los datos de ventas de forma PERMANENTE.\n\n' +
				'Se eliminar√°n:\n' +
				'‚Ä¢ Todos los pedidos\n' +
				'‚Ä¢ Todas las transacciones\n' +
				'‚Ä¢ Todos los cierres de caja\n' +
				'‚Ä¢ Todas las facturas guardadas\n\n' +
				'Los productos del cat√°logo NO se eliminar√°n.\n\n' +
				'Escribe "CONFIRMAR" (en may√∫sculas) para proceder:'
			);

			if (confirmation !== 'CONFIRMAR') {
				alert('Operaci√≥n cancelada.');
				return;
			}

			try {
				// Limpiar √≥rdenes
				AppState.orders = [];
				await API.save('orders', []);

				// Limpiar transacciones
				AppState.transactions = [];
				await API.save('transactions', []);

				// Limpiar cierres de caja
				AppState.cashClosures = [];
				await API.save('cash_closures', []);

				alert('‚úÖ Datos de ventas eliminados correctamente.\n\nLa aplicaci√≥n est√° lista para uso en producci√≥n.');
				
				// Refrescar vistas
				renderDashboard();
				renderOrders();
				renderTransactions();
				updateSystemInfo();
				
			} catch (error) {
				alert('‚ùå Error al limpiar datos: ' + error.message);
				console.error(error);
			}
		}

		function updateSystemInfo() {
			document.getElementById('info-menu-items').textContent = AppState.menuItems.length;
			document.getElementById('info-orders').textContent = AppState.orders.length;
			
			// Contar clientes √∫nicos (pedidos con customerData)
			const uniqueCustomers = new Set();
			AppState.orders.forEach(order => {
				if (order.customerData && order.customerData.name) {
					uniqueCustomers.add(order.customerData.name.toLowerCase());
				}
			});
			document.getElementById('info-customers').textContent = uniqueCustomers.size;
			
			// Contar facturas guardadas
			const invoicesCount = AppState.transactions.filter(t => t.invoicePDF).length;
			document.getElementById('info-invoices').textContent = invoicesCount;
		}

		// Funci√≥n para cerrar sesi√≥n
		function logout() {
			if (confirm('¬øCerrar sesi√≥n?')) {
				localStorage.removeItem('userSession');
				window.location.href = '/login.html';
			}
		}

		// Funci√≥n para activar notificaciones manualmente
		async function enableNotifications() {
			if (!("Notification" in window)) {
				alert("‚ùå Tu navegador no soporta notificaciones del sistema.");
				return;
			}

			try {
				const permission = await Notification.requestPermission();
				updateNotificationStatus();
				
				if (permission === "granted") {
					// Mostrar notificaci√≥n de prueba con vibraci√≥n
					if ('vibrate' in navigator) {
						navigator.vibrate([200, 100, 200, 100, 200]);
					}
					
					const testOptions = {
						body: "Recibir√°s alertas de nuevos pedidos en tiempo real, incluso cuando la app est√© en segundo plano.",
						icon: "/image.png",
						badge: "/icon-192.png",
						tag: "test-notification",
						requireInteraction: false,
						vibrate: [200, 100, 200, 100, 200]
					};

					// Usar Service Worker si est√° disponible
					if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
						navigator.serviceWorker.controller.postMessage({
							type: 'SHOW_NOTIFICATION',
							title: '‚úÖ ¬°Notificaciones Activadas!',
							options: testOptions
						});
					} else {
						// Fallback: notificaci√≥n directa
						const testNotif = new Notification("‚úÖ ¬°Notificaciones Activadas!", testOptions);
						setTimeout(() => testNotif.close(), 5000);
					}
				} else if (permission === "denied") {
					alert("‚ùå Has bloqueado las notificaciones.\n\nPara activarlas:\n1. Ve a configuraci√≥n del navegador\n2. Busca 'Notificaciones' o 'Permisos'\n3. Permite notificaciones para este sitio");
				}
			} catch (error) {
				console.error('Error al solicitar permiso de notificaciones:', error);
				alert("‚ùå Error al activar notificaciones. Intenta de nuevo.");
			}
		}

		// Funci√≥n para actualizar el estado visual de las notificaciones
		function updateNotificationStatus() {
			const statusDiv = document.getElementById('notification-status');
			const button = document.getElementById('enable-notifications-btn');
			
			if (!statusDiv || !button) return;

			if (!("Notification" in window)) {
				statusDiv.innerHTML = `
					<div style="background: rgba(255, 68, 68, 0.1); border-left: 4px solid #ff4444; padding: 10px;">
						‚ùå Tu navegador no soporta notificaciones del sistema
					</div>
				`;
				button.style.display = 'none';
				return;
			}

			const permission = Notification.permission;

			if (permission === "granted") {
				statusDiv.innerHTML = `
					<div style="background: rgba(76, 175, 80, 0.1); border-left: 4px solid #4caf50; padding: 10px;">
						‚úÖ <strong>Notificaciones Activadas</strong><br>
						<span style="color: var(--muted); font-size: 13px;">
							Recibir√°s alertas en tiempo real de nuevos pedidos
						</span>
					</div>
				`;
				button.textContent = "‚úÖ Notificaciones Activas";
				button.disabled = true;
				button.style.opacity = "0.6";
			} else if (permission === "denied") {
				statusDiv.innerHTML = `
					<div style="background: rgba(255, 68, 68, 0.1); border-left: 4px solid #ff4444; padding: 10px;">
						‚ùå <strong>Notificaciones Bloqueadas</strong><br>
						<span style="color: var(--muted); font-size: 13px;">
							Debes habilitarlas desde la configuraci√≥n del navegador
						</span>
					</div>
				`;
				button.textContent = "üîí Desbloquear en Configuraci√≥n";
				button.disabled = true;
				button.style.opacity = "0.6";
			} else {
				statusDiv.innerHTML = `
					<div style="background: rgba(212, 168, 150, 0.1); border-left: 4px solid var(--beige); padding: 10px;">
						‚ö†Ô∏è <strong>Notificaciones No Configuradas</strong><br>
						<span style="color: var(--muted); font-size: 13px;">
							Haz clic en el bot√≥n para activarlas
						</span>
					</div>
				`;
				button.textContent = "üîî Activar Notificaciones";
				button.disabled = false;
				button.style.opacity = "1";
			}
		}

		init();
	</script>
</body>
</html>